<?xml version="1.0" encoding="utf-8"?>

<domain name="megaport" xmlns="http://unact.net/xml/xi">

    <concept name="mp-agent">
        
        <select owner="megaport" sql-name="agent"/>
        
        <select owner="megaport" sql-name="agentsByZone" type="procedure">
            <parameter name="mp-zone" type="int" sql-name="@zone" required="true"/>
        </select>
        
        <property name="id" type="int" key="true"/>
        
        <property name="name" label="Имя"/>
        <property name="loginname" type="string" label="Логин" />
        
        <role name="mp-zone" actor="mp-zone"/>
        
    </concept>


    <concept name="mp-terminal">
        
        <select owner="megaport" sql-name="terminal"/>
        
        <property name="lastactivitytime" type="datetime" label="Последний сигнал"/>
        <property name="lastpaymenttime" type="datetime" label="Последний платеж"/>
        
        <property name="error" type="string" label="Ошибка" sql-name="errortext"/>
        
        <property name="name" type="string" label="Название"/>
        <property name="address" type="string" label="Адрес"/>
        <property name="code" type="string" label="Код"/>
        <property name="terminalid" type="int" label="ID"/>
        
    </concept>
    

    <concept name="mp-zone">
        
        <select owner="megaport" sql-name="zone"/>
        
        <select owner="megaport" sql-name="zonesByUsername" type="procedure">
            <parameter name="username" sql-name="@username" required="true"/>
        </select>
        
        <select owner="megaport" sql-name="zonesByAgent" type="procedure">
            <parameter name="mp-agent" sql-name="@agent" required="true"/>
        </select>
        
        <property name="id" type="int" key="true"/>
        <property name="agent-type" sql-name="agent_type"/>
        
        <property name="name" label="Название"/>
        
        <property name="agent-type-name" label="Тип зоны" sql-compute="
            case agent_type
                when 'megaport.techniks' then 'Техники'
                when 'megaport.encashers' then 'Инкассаторы'
            end
        "/>
        
        <role name="mp-agent" actor="mp-agent" sql-name="agent"/>
        
    </concept>
    

    <concept name="mp-zone-terminal">
        
        <select owner="dbo" sql-name="pps_zone_terminal"/>
        
        <role name="mp-terminal" actor="mp-terminal" sql-name="pps_terminal"/>
        <role name="mp-zone" actor="mp-zone" sql-name="zoneid"/>
        
    </concept>


    <concept name="mp-agent-duty">
        
        <select owner="megaport" sql-name="agent_route"/>
        
        <property name="date" type="date" sql-name="ddate" label="Дата"/>
        <property name="ndoc" label="Номер маршрута"/>
        
        <role name="mp-agent" actor="mp-agent" sql-name="agent"/>
        <role name="mp-zone" actor="mp-zone" sql-name="zone"/>
        
    </concept>


    <concept name="mp-agent-duty-task">
        
        <select owner="megaport" sql-name="agent_route_point"/>
        
        <property name="is-served" type="boolean" label="Выполнено?" sql-name="servstatus"/>
        <property name="is-penalty-canceled" type="boolean" label="Отмена штрафа?" sql-name="penaltystatus"/>
        <property name="info" label="Пояснение" />
        
        <role name="mp-agent-duty" actor="mp-agent-duty" sql-name="agent_route"/>
        <role name="mp-terminal" actor="mp-terminal" sql-name="terminal"/>
        
    </concept>


</domain>