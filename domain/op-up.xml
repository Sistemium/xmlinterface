<?xml version="1.0" ?>
<domain version="1.0"
    xmlns:xi="http://unact.net/xml/xi"
    xmlns="http://unact.net/xml/xi"
>

    <concept name="op-hold-reason" server="op.unact.ru">
        <select owner="op" sql-name="holdRule"/>
        
        <property name="id" type="int" key="true" />
        <property name="name" type="string" />
        
        <property name="xid" />
    </concept>
    
    <concept name="op-payment" server="op.unact.ru">
        <select owner="op" sql-name="payment"/>
        <save owner="op" sql-name="payment"/>
        
        <property name="id" type="int" key="true" label="ОП-ИД"/>
        <property name="xid" />
        
        <property name="clientId" type="string" label="Клиентский ИД"/>
        <property name="clientSessionTerminal" type="string" label="Терминальный ИД"/>
        
        <property name="summ" type="decimal" label="Сумма к зачислению"/>
        <property name="summTerminal" type="decimal" label="Сумма полная"/>
        <property name="terminal-fee" type="decimal" label="Комиссия терминала" sql-compute="summTerminal - summ"/>
        <property name="terminalID" type="string"/>
        <property name="account" type="string" label="Счет" />
        <property name="extra" type="xml" label="Прочие реквизиты" />
        <property name="final" type="boolean" />
        <property name="on-hold" type="boolean" sql-name="onHold" label="Заблокирован"/>
        
        <property name="receipt-number" type="string"  sql-compute="left(clientSessionTerminal,20)"/>
        <property name="receipt-date" type="string" sql-compute="op.receiptDateTime(clientSessionTerminal)"/>
        
        <property name="status" type="string" label="Статус"
                  sql-compute="case when final=0 then 'Проводится' when error=0 then 'Проведено' else string('Ошибка=',error) end"/>
        
        <property name="smsNumber" type="string" label="Номер обратной связи"/>
        <property name="virtualCard" type="string"/>
        
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение" sql-index="xk_payment_ts"/>
        
        <role name="op-legalentity" actor="op-legalentity" sql-name="legalentity" />
        <role name="op-service" actor="op-service" sql-name="service" />        
        <role name="op-error" actor="op-error" sql-name="error" false-means-zero="true" />
        <role name="op-hold-reason" actor="op-hold-reason" sql-name="holdRule" />
        <role name="up-client" actor="up-client" sql-name="client" />
        <role name="up-file" actor="up-file" sql-name="CSVFile" />
        <role name="up-file-payment" actor="up-file-payment" sql-name="prepayment" />
        
        <index name="accounts" sql-name="account, extra" label="Слова в реквизитах"/>
    </concept>

    <concept name="op-payment-process" server="op.unact.ru">
        <select owner="op" sql-name="paymentprocess"/>
        
        <select owner="op" sql-name="paymentProcessRegister">
            <parameter name="op-payment-register" required="true"/>
        </select>
        
        <save owner="op" sql-name="paymentProcessRegister"/>
        
        <property name="id" type="int" key="true"/>
        <property name="xid" />
        
        <property name="step" type="int" label="Шаг"/>
        <property name="tryCount" type="int" label="Всего попыток"/>
        <property name="stepTryCount" type="int" label="Попыток текущего шага"/>
        <property name="finalizingDate" type="datetime" label="Дата завершения"/>
        <property name="bookingDate" type="date" label="Дата биллинга"/>
        
        <property name="clientId" type="string"/>
        <property name="summ" type="decimal" label="Сумма"/>
        <property name="account" type="string" label="Счет" />
        <property name="extra" type="xml" label="Прочие реквизиты" />
        <property name="final" type="boolean" />
        
        <property name="status" type="string" label="Статус"
                  sql-compute="case when final=0 then 'Проводится' when error=0 then 'Проведено' else string('Ошибка=',error) end"/>
        
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение"/>
        
        <role name="op-service" actor="op-service" sql-name="service" />        
        <role name="op-error" actor="op-error" sql-name="error" />
        <role name="op-payment" actor="op-payment" sql-name="payment" />
        <role name="pc-account" actor="pc-account" sql-name="pcAccount" />
        
        <role name="op-payment-register" actor="op-payment-register" sql-name="csvRegister" />
        <role name="op-csv-error" actor="op-csv-error" sql-name="csvError" />
        <role name="up-file-payment" actor="up-file-payment" sql-name="prepayment" />
        
    </concept>

    <concept name="op-error" server="op.unact.ru">
        <select owner="op" sql-name="processError"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название" />
        
    </concept>


    <concept name="op-csv-error" server="op.unact.ru">
        
        <select owner="op" sql-name="csvProcessError"/>
        
        <property name="id" type="int" key="true" />
        <property name="name" type="string" label="Название" />
        
    </concept>
    
    
    <concept name="op-payment-register" server="op.unact.ru">
        
        <select owner="op" sql-name="csvRegister"/>
        
        <select owner="op" sql-name="csvRegisterNew" type="procedure">
            <parameter name="pc-account" type="int" sql-name="@pcaccount"/>
            <parameter name="blank-number" type="int" sql-name="@seed" required="true"/>
        </select>
        
        <save owner="op" sql-name="csvRegister"/>
        
        <property name="xid" />
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Номер" />
        <property name="date" type="date" label="Дата" sql-name="ddate"/>
        <property name="processed" type="boolean" label="Проведено" />
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение"/>
        
        <role name="pc-account" actor="pc-account" sql-name="pcaccount"/>
        
    </concept>

    
    <concept name="up-file-payment-claim" server="op.unact.ru">
        <select owner="op" sql-name="paymentClaim"/>
        <save owner="op" sql-name="paymentClaim"/>
        
        <field name="id" type="int" key="true"/>
        
        <property name="phoneNumber" type="string" label="Телефонный номер" />
        
        <property name="account" type="string" label="Счет" />
        <property name="contract" type="string" label="Карта/договор" />
        <property name="bik" type="string" label="БИК" />
        
        <property name="firstName" type="string" label="Имя" />
        <property name="lastName" type="string" label="Фамилия" />
        <property name="middleName" type="string" label="Отчество" />
        
        <property name="terminal" type="string" label="Номер терминала" />
        <property name="terminal-address" type="string" label="Адрес терминала" sql-name="terminal_address"/>
        
        <property name="extra" type="xml" />
        
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение"/>
        
        <role name="up-file-payment" actor="up-file-payment" sql-name="prepayment" />
        
    </concept>
    
    
    <concept name="up-file-payment-claim-terminal" storage="mssql" server="pps" db="ppscat">
        
        <select owner="dbo" sql-name="csvMultibankTerminalForAmendmentClaim" type="procedure">
            <parameter name="date" sql-name="@date" type="string"/>
            <parameter name="summ" sql-name="@summ" type="decimal"/>
        </select>
        
        <property name="id" type="int" sql-name="terminalid" />
        
        <role name="bank-terminal" actor="bank-terminal" sql-name="terminalid" />
        
    </concept>

    <concept name="up-file-payment" server="op.unact.ru">
        
        <select owner="op" sql-name="prepayment" />
        <select owner="xmlgate" sql-name="prepaymentCsvFile">
            <parameter name="up-file-type" required="true"/>
        </select>
        
        <!--save owner="op" sql-name="prepayment_ammend" type="procedure">
            <parameter name="ammendment-reason" type="int" required="true" sql-name="@reason"/>
        </save-->
        
        <property name="id" type="int" key="true"/>
        <property name="xid" />
        
        <property name="account" type="string" label="Счет" />
        <property name="summ" type="decimal" label="Сумма к зачислению" />
        <property name="extra" type="xml" label="Прочие реквизиты" />
        
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение"/>
        
        <role name="op-error" actor="op-error" sql-name="error" />
        <role name="up-file" actor="up-file"  sql-name="csvfile"/>
        <role name="up-client" actor="up-client" sql-name="client"/>
        <role name="up-file-type" actor="up-file-type" sql-name="csvFileType"/>
        
        <index name="accounts" sql-name="account, extra" label="Слова в реквизитах"/>
        
    </concept>


    <concept name="up-file-type" server="op.unact.ru">
        <select owner="op" sql-name="CSVFileType"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название" />
        <property name="code" type="string" label="Код" />
        
    </concept>

    <concept name="up-file" server="op.unact.ru">
        <select owner="op" sql-name="CSVFile"/>
        <save owner="op" sql-name="CSVFile"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Имя" />
        <property name="data" type="file" label="Данные платежей" />
        
        <property name="processed" type="boolean" label="Проведено"/>
        
        <property name="cts" type="datetime" label="Загружен"/>
        
        <property name="xid" />
        
        <role name="up-file-type" actor="up-file-type" sql-name="type"/>
        <role name="up-client" actor="up-client" sql-name="client"/>
        
    </concept>

    <concept name="up-client" server="op.unact.ru">
        <select owner="op" sql-name="client"/>
        
        <select owner="xmlgate" type="procedure" sql-name="client">
            <parameter name="op-agent" type="string" sql-name="@agent" required="true"/>
        </select>
        
        <save owner="xmlgate" sql-name="client"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" label="Название" type="string"/>
        <property name="processingLogin" label="Платежный логин" type="string" sql-name="login"/>
        <property name="processingPwd" label="Платежный пароль" type="string" sql-compute="null"/>
        <property name="processingPwdNew" label="Новый платежный пароль" type="string" sql-compute="null"/>
        
        <property name="funds" label="Остаток средств" type="decimal"/>
        <property name="fundsAvailable" label="Доступно с овердрафтом" type="decimal"
                  sql-compute="(select op.clientFundsAvailable (id))"/>
        
        <role name="op-agent" actor="op-agent"/>
    
    </concept>
    
    <concept name="up-overdraft">
        <select owner="op" sql-name="overdraft"/>
        
        <property name="dateB" type="datetime" sql-name="ddateb" label="Начало действия"/>
        <property name="dateE" type="datetime" sql-name="ddatee" label="Окончание действия"/>
        <property name="summ" type="decimal" label="Сумма"/>
        
        <role name="up-client" actor="up-client" sql-name="client"/>

    </concept>

    <concept name="up-clientDate">
        <select owner="xmlgate" type="procedure" sql-name="clientDate">
            <parameter name="up-client" type="int" sql-name="@client"/>
        </select>
        
        <property name="date" label="Дата" type="date" sql-name="ddate"/>
        
        <property name="fundsIncome" label="Поступило средств" type="decimal"/>
        <property name="paymentsSum" label="Проведено на сумму" type="decimal"/>
        
        <role name="up-client" actor="up-client" sql-name="client"/>
        
    </concept>

    <concept name="op" server="op.unact.ru">    
        <select owner="sys" sql-name="dummy"/>
        <select owner="xmlgate" type="procedure" sql-name="agent">
            <parameter name="name" type="string" sql-name="@name" required="true"/>
            <parameter name="device-name" type="string" sql-name="@deviceName"/>
        </select>
        
        <property name="id" type="int" key="true"/>
        
    </concept>

    <concept name="op-agent" server="op.unact.ru">
        
        <select owner="xmlgate" type="procedure" sql-name="agent">
            <parameter name="name" type="string" sql-name="@name" required="true"/>
            <parameter name="device-name" type="string" sql-name="@deviceName"/>
        </select>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" />
        
    </concept>
    
    <concept name="legalentity-pc" server="op.unact.ru">
        
        <select owner="op" sql-name="legalentityPc"/>
        <save owner="op" sql-name="legalentityPc"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название" />
        <property name="funds" type="decimal" label="Свободно средств" />
        <property name="minFunds" type="decimal" label="Порог оповещения" />
        <property name="processedToday" type="decimal" label="Проведено сегодня" />
        
        <property name="active" type="boolean" label="Активно" />
        
    </concept>
    
    <concept name="gup-reestr" server="op.unact.ru">
        <select owner="report" sql-name="gupMgstkNalogReestr" type="procedure">
            <parameter name="date" type="date" sql-name="@dateb"/>
        </select>
    </concept>
    
    <concept name="multibank-reestr" server="op.unact.ru">
        <select owner="report" sql-name="multibankReestr" type="procedure">
            <parameter name="date" type="date" sql-name="@dateb"/>
            <parameter name="op-payment-register" type="int" sql-name="@csvRegister"/>
            <parameter name="kind" type="string" sql-name="@paymentKind"/>
        </select>
        <role name="op-payment-register" actor="op-payment-register" />
    </concept>

    <concept name="pc-account" server="op.unact.ru">
    
        <select owner="op" sql-name="pcAccount"/>
        <save owner="op" sql-name="pcAccount"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Имя" />
        <property name="active" type="boolean" label="Активен" />
        <property name="handBlock" type="boolean" label="Отключить" />
        <property name="login" type="string" label="Логин" />
        <property name="pwd" type="string" label="Пароль" />
        <property name="terminal" type="string" label="Терминал" />
        <property name="terms" type="string" label="Прочие условия" />
        <property name="url" type="string" label="URL" />
        <property name="certfile" label="Файл сертификата" />
        <property name="url2" type="string" label="URL2" />
        <property name="onlineCheck" type="boolean" label="Использовать для проверок" />
        <property name="email" type="string" label="Почта" />

        <role name="legalentity" actor="op-legalentity"/>
        <role name="pc" actor="pc"/>
        
    </concept>

    <concept name="op-legalentity" server="op.unact.ru">
    
        <select owner="op" sql-name="legalentity"/>
        <save owner="op" sql-name="legalentity"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название"/>
        <property name="code" type="string" label="Код"/>
        <property name="ratio" type="int" label="Целевой %"/>
        <property name="todayPercent" type="decimal" label="% Сегодня" 
            sql-compute="cast(100*(select summ from op.legalentitytotal where ddate=today() and legalentity=[op-legalentity].id) /
                         (select sum(summ) from op.legalentitytotal where ddate=today()) as decimal(5,2))"
        />
        <property name="todayPaymentsSum" type="decimal" label="Платежи сегодня" 
            sql-compute="(select summ from op.legalentitytotal where ddate=today() and legalentity=[op-legalentity].id)"
        />

        <property name="xid"/>
        
    </concept>

    <concept name="protocol" server="op.unact.ru">
    
        <select owner="op"/>
        <save owner="op"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название"/>
        <property name="code" type="string" label="Код"/>

        <property name="xid"/>
        
    </concept>

    <concept name="op-service" server="op.unact.ru">
    
        <select owner="op" sql-name="service"/>
        <save owner="op" sql-name="service"/>
        
        <property name="xid" />
        <property name="ts" type="datetime" label=""/>
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название"/>
        <property name="code" type="string" label="Код"/>
        
        <property name="terms" type="string" label="terms" />
        <property name="etc" type="xml" label="Прочие параметры" />
        <property name="inUse" type="boolean" label="inUse" />
        <property name="successfulPayment" type="boolean" label="successfulPayment" />
        <property name="disabled" type="boolean" label="disabled" />
        <property name="restrictedFee" type="boolean" label="restrictedFee" />
    </concept>

    <concept name="pc" server="op.unact.ru">
    
        <select owner="op"/>
        <save owner="op"/>
                    
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название"/>
        <property name="code" type="string" label="Код"/>
        <property name="avoid" type="boolean" label="Избегать"/>
        <property name="maxQueue" type="int" label="Потолок очереди"/>
        <property name="maxTries" type="int" label="Потолок попыток"/>
        <property name="processCount" type="int" label="Потолок процессора"/>
        <property name="xid"/>
        
        <role name="protocol" actor="protocol"/>
        
    </concept>
    
    <!--concept name="pc-account-total" server="op.unact.ru">
    
        <select owner="op" type="procedure" sql-name="pcaccountTotalToday"/>

        <property name="summ" type="decimal" label="Проведено на сумму"/>
        <property name="mfd" type="datetime" label="Последний платеж"/>
        
        <role name="pc-account" actor="pc-account" sql-name="pcaccount"/>
        
    </concept-->

    <concept name="pc-queue-error" server="op.unact.ru">
    
        <select owner="op" type="procedure" sql-name="queueerrors"/>

        <property name="account" type="string" label="ПЦ"/>
        <property name="service" type="string" label="Услуга"/>
        <property name="error" type="string" label="Ошибка"/>
        <property name="cnt" type="int" label="Платежей в очереди"/>
        <property name="trycountAvg" type="decimal" label="Попыток в среднем"/>
        
    </concept>

    <concept name="pc-queueinfo" server="op.unact.ru">
    
        <select owner="op" type="procedure" sql-name="queueinfo"/>

                    
        <property name="name" type="string" label="ПЦ"/>
        <property name="avoid" type="boolean" label="Избегать"/>
        <property name="nonFinalCount" type="int" label="Шт. в очереди"/>
        <property name="ppin" type="int" label="Вход шт/мин"/>
        <property name="ppout" type="int" label="Выход шт/мин"/>
        <property name="deltain2" type="int" label="Дельта Вход"/>
        <property name="deltaout2" type="int" label="Дельта Выход"/>
        
    </concept>

    <concept name="op-incident" server="op.unact.ru">
        
        <select owner="op" sql-name="incident"/>
        <save owner="op" sql-name="incident"/>
        
        <property name="id" type="int" key="true"/>
        
        <property name="source" type="string" />
        <property name="header" type="string" label="Тема"/>
        <property name="data" type="string" label="Детали"/>
        <property name="closed" type="boolean" label="Завершен"/>
        
        <property name="cts" type="datetime" label="Когда создан" />
        <property name="ts" type="datetime" label="Последнее изменение"/>
        
        <property name="xid"/>
        
    </concept>
    
</domain>