<?xml version="1.0" ?>
<domain version="1.0"
    xmlns:xi="http://unact.net/xml/xi"
    xmlns="http://unact.net/xml/xi"
>

    <concept name="workday-encashment">
        
        <select owner="dbo" sql-name="palm_repayment"/>
        <save owner="dbo" sql-name="palm_repayment"/>
        
        <property name="id" type="int" key="true" sql-name="repayment_id"/>
        <property name="xid"/>
        
        <property name="date" type="datetime" label="Время регистрации" sql-name="ddate"/>
        <property name="summ" type="decimal" label="Сумма" />
        <property name="isWhite" type="string" label="Чек" sql-compute="if kkmprinted=1 then 'Чек' endif" />
        <property name="wsumm" type="decimal" label="С чеком" sql-compute="if kkmprinted=1 then summ endif"/>
        <property name="bsumm" type="decimal" label="Без чека" sql-compute="if kkmprinted=0 then summ endif"/>
        
        <role name="salesman-workday" actor="salesman-workday" sql-name="saleperiod_id"/>
        <role name="cat-buyer" actor="cat-buyer" sql-name="client_id"/>
        
    </concept>

    <concept name="expedition">
        <select owner="dbo" type="procedure">
            <parameter name="cat-agent" type="int" sql-name="@agent"/>
            <parameter name="date" type="date" sql-name="@ddate"/>
        </select>
        <save owner="dbo" type="procedure" sql-name="expedition_save">
            <!--parameter name="xid" sql-name="@xid"/-->
            <parameter name="id" type="int" sql-name="@id" />
            <parameter name="started" type="int" sql-name="@started" />
            <parameter name="finished" type="int" sql-name="@finished" />
        </save>
                    
        <property name="id" type="int" key="true"/>
        <property name="xid" />
        
        <role name="cat-agent" actor="cat-agent" sql-name="agent"/>
        <property name="date" type="date" label="Дата" sql-name="ddate"/>

        <property name="name" type="string" label="Доставка" />
        <property name="started" type="boolean" label="Произведен выезд" />
        <property name="finished" type="boolean" label="Маршрут завершен" />

    </concept>

    <concept name="expedition-destination">
        <select owner="dbo" type="procedure" sql-name="expedition_destination_test">
            <parameter name="expedition" type="int" sql-name="@expedition" />
        </select>
        <save owner="dbo" sql-name="expedition_destination"/>
        
        <role name="expedition" actor="expedition" sql-name="delivery"/>
        <role name="cat-buyer" actor="cat-buyer" sql-name="destination"/>

        <property name="xid" />
        
        <property name="id" type="int" key="true"/>
        <property name="ord" type="string" label="Очередность" />
        <property name="address" type="string" label="Адрес" />
        <property name="isComplete" type="boolean" label="Завершена работа" />
        
        <!--property name="finished" type="boolean" label="Заказы переданы" sql-compute="if departure is null then 1 else 0 endif"/>
        <property name="started" type="boolean" label="Посещено" sql-compute="if arrival is null then 1 else 0 endif"/-->
        
        <property name="ordersCnt" type="int" label="Кол-во заказов" />
        <property name="documentsCnt" type="int" label="Кол-во документов" />
        <property name="encashmentsCnt" type="boolean" label="Инкассация" />

        <property name="name" type="string" label="Название" sql-compute="string(address)"/>

    </concept>

    <concept name="expedition-order-task">
        <select owner="dbo" type="procedure" sql-name="expedition_order_task">
            <parameter name="expedition" type="int" sql-name="@expedition" />
            <parameter name="cat-buyer" type="int" sql-name="@destination" />
        </select>
        
        <property name="id" type="int" key="true"/>
        
        <property name="ndoc" type="string" label="Документ№" />
        <property name="summ" type="decimal" label="Сумма" />
        <property name="mcvol" type="decimal" label="Коробок" />
        <property name="goodsCnt" type="decimal" label="Товаров" />
        <property name="info" type="string" label="Комментарий" />

        <role name="cat-buyer" actor="cat-buyer" />
        <role name="expedition" actor="expedition" />
        
    </concept>

    <concept name="pos-debt">
        <select owner="dbo" type="procedure" sql-name="pos_debt">
            <parameter name="cat-partner" type="int" sql-name="@partner" />
            <parameter name="cat-salesman" type="int" sql-name="@salesman"/>
        </select>
        
        <property name="id" type="int" key="true"/>
        
        <property name="isWhite" type="boolean" label="Нужен чек" sql-compute="if color=1 then 1 else 0 endif" />
        <property name="needs" type="string" label="Нужно" sql-compute="if color=1 then 'Чек' endif" />
        <property name="info" type="string" label="Документ№" />
        <property name="summ" type="decimal" label="Сумма" />
        <property name="csum" type="decimal" label="Задолженность" />
        <property name="date" type="date" label="Дата" sql-name="ddate"/>
        <property name="dateUntil" type="date" label="Оплата до" sql-name="date_until"/>
        <property name="isOwn" type="boolean" sql-name="own"/>
        <property name="isOverdue" type="boolean" sql-name="overdue" label="Просрочено"/>

        <role name="cat-partner" actor="cat-partner" />
        <role name="debt-origin" actor="cat-partner" sql-name="partner"/>
        <role name="cat-buyer" actor="cat-buyer" sql-name="client"/>
        <role name="cat-salesman" actor="cat-salesman" />
        
    </concept>


    <concept name="expedition-encashment-task">
        <select owner="dbo" type="procedure" sql-name="expedition_encashment_task">
            <parameter name="expedition-destination" type="int" sql-name="@destination" />
            <parameter name="salesman-workday" type="int" sql-name="@saleperiod" />
            <parameter name="expedition" type="int" sql-name="@expedition" />
        </select>
        
        <property name="id" type="int" key="true"/>
        
        <property name="isWhite" type="string" label="Нужно" sql-compute="if color=1 then 'Чек' endif" />
        <property name="info" type="string" label="Документ№" />
        <property name="summ" type="decimal" label="Сумма" />
        <property name="csum" type="decimal" label="Задолженность" />
        <property name="date" type="date" label="Дата" sql-name="ddate"/>

        <property name="name" type="string" sql-compute="string(date(ddate),' ',info,' ',summ,' ',csum)" />

        <role name="expedition" actor="expedition" />
        <role name="expedition-destination" actor="expedition-destination" />
        <role name="salesman-workday" actor="salesman-workday" />
        
    </concept>

    <concept name="expedition-encashment">
        <select owner="dbo" sql-name="expedition_encashment"/>
        <save owner="dbo" sql-name="expedition_encashment"/>
        
        <property name="id" type="int" key="true"/>
        <property name="xid" />
        
        <property name="summ" type="decimal" label="Оплачено" />
        <property name="date" type="date" label="Дата" sql-name="ddate"/>

        <role name="expedition-encashment-task" actor="expedition-encashment-task" sql-name="task"/>
        <role name="salesman-workday" actor="salesman-workday" sql-name="saleperiod_id"/>
        <role name="expedition-destination" actor="expedition-destination" sql-name="client_id"/>
        <role name="cat-buyer" actor="cat-buyer" sql-name="client_id"/>
        <role name="wan-pos" actor="wan-pos" sql-name="client_id"/>
        <role name="pos-debt" actor="pos-debt" sql-name="task"/>
        
    </concept>

    <!--concept name="expedition-item">
        <select owner="dbo" type="procedure" sql-name="expedition_item">
            <parameter name="destination" type="int" sql-name="@destination" />
        </select>
        
        <save owner="dbo" type="procedure" sql-name="expedition_item_save">
            <parameter name="xid" sql-name="@xid"/>
            <parameter name="arrive" type="int" sql-name="@started"/>
            <parameter name="leave" type="int" sql-name="@finished"/>
        </save>
        
        <role name="destination" actor="expedition-destination"/>
        
        <property name="xid" />
        
        <property name="arrive" type="boolean" label="Прибыл" />
        <property name="leave" type="boolean" label="Убыл" />

    </concept-->


</domain>
