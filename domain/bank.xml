<?xml version="1.0" ?>
<domain version="1.0"
    xmlns:xi="http://unact.net/xml/xi"
    xmlns="http://unact.net/xml/xi"
>

    <concept name="processing">
        <select owner="dbo" sql-name="src_system"/>
        
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string"/>
        <property name="code" type="string"/>
        
    </concept>

    <concept name="branch">
        <select owner="spp" type="procedure" sql-name="BranchByLogin">
            <parameter name="username" type="string" sql-name="@login"/>
        </select>
        <save owner="dbo" sql-name="branch"/>
        
        <property name="username" type="string" sql-name="AD_login"/>
        <property name="name" type="string" label="Имя" />
        <property name="id" type="int" key="true" />
        <property name="grantees" type="string" sql-name="ad_login" label="Пользователи" />
        <property name="office-name" type="string" sql-name="officename" label="Официальное название" />
        <property name="headcashier-position" type="string" sql-name="headcashierdol" label="Должность главного кассира" />
    </concept>
    

    <concept name="catterminal">
        <select owner="dbo" sql-name="catterminal"/>
        <select owner="dbo" sql-name="catterminalByUPClientOPTerminal">
            <parameter name="up-client" type="int" sql-name="@client"/>
            <parameter name="terminalID" type="int" sql-name="@terminalID"/>
        </select>
        
        <save owner="dbo" sql-name="catterminal"/>
        
        <role name="branch" actor="branch"/>
        <role name="processing" actor="processing" sql-name="src_system"/>
        <role name="branch-route" actor="branch-route" sql-name="broute"/>

        <property name="id" type="int" key="true"/>
        <property name="lifestatus" type="string" sql-compute="case isdeleted when 0 then 'Работает' when 1 then 'Удален' end" />
        <property name="branch-route.name" type="string"/>

        <property name="name" type="string" label="Название"/>
        <property name="address" type="string" label="Адрес"/>
        <property name="code" type="string" label="Код"/>
        <property name="terminalid" type="int" label="ID"/>
        
        <index name="searcher" sql-name="terminalid, name, address" />
        
    </concept>

    <!--concept name="branch-route-terminal">
        <select owner="dbo" sql-name="branch_routeterm"/>
        <save owner="dbo" sql-name="branch_routeterm"/>
        
        <role name="branch-route" actor="branch-route" sql-name="broute"/>
        <role name="cat/terminal" actor="cat/terminal" sql-name="terminalid"/>
        <property name="id" type="int" key="true"/>
    </concept-->

    <concept name="branch-workday-cashier">
        <select owner="dbo" sql-name="bday_cashier"/>
        <save owner="dbo" sql-name="bday_cashier"/>
        
        <role name="branch-workday" actor="branch-workday" sql-name="branch_day"/>
        <role name="cashier" actor="cashier"/>

        <property name="id" type="int" key="true"/>
    </concept>


    <concept name="branch-workday-route">
        <select owner="dbo" type="procedure" sql-name="bday_route">
            <parameter name="branch-workday" type="int" sql-name="@bday"/>
        </select>
        <save owner="dbo" sql-name="bday_route"/>
        
        <role name="branch-workday" actor="branch-workday" sql-name="bday"/>
        <role name="branch-route" actor="branch-route" sql-name="broute"/>
        <role name="collector" actor="collector"/>

        <property name="id" type="int" key="true"/>
    </concept>

    <concept name="branch-route">
        <select owner="dbo" sql-name="branch_route"/>
        <save owner="dbo" sql-name="branch_route"/>
        
        <role name="branch" actor="branch"/>
        <property name="id" type="int" key="true"/>
        <property name="name" type="string"/>
        <property name="description" type="string"/>
    </concept>

    <concept name="bpa" storage="mssql" server="pps" db="ppscat">
        <select owner="dbo" sql-name="bpatable"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название" />
    </concept>

    <concept name="cat-bpa">
        <select owner="dbo" sql-name="bpa"/>
        <save owner="dbo" sql-name="bpa"/>
        
        <property name="id" type="int" key="true"/>
        <property name="name" type="string" label="Название" />
        <property name="distrib-ratio" type="decimal" label="Вес в распределении" sql-name="distrib_ratio"/>
    </concept>


    <concept name="cashier">
        <select owner="dbo"/>
        <save owner="dbo"/>
        <role name="branch" actor="branch"/>
        <property name="name" type="string"/>
        <property name="id" type="int" key="true"/>
        <property name="code" type="string"/>
    </concept>

    <concept name="collector">
        <select owner="dbo"/>
        <save owner="dbo"/>
        <role name="branch" actor="branch"/>
        <property name="name" type="string"/>
        <property name="id" type="int" key="true"/>
        <property name="code" type="string"/>
    </concept>

    <concept name="EncashmentAmendment" storage="cat">
        <select type="procedure" owner="spp">
            <parameter name="ddate" type="date" sql-name="@ddate"/>
        </select>
    </concept>

    <concept name="AccessDate" storage="cat">
        <select owner="dbo"/>
        <save owner="dbo"/>
        <property name="username" key="true"/>
        <property name="ddate" type="datetime"/>
    </concept>

    <concept name="TerminalRoutes">
        <select type="procedure" owner="spp" sql-name="TerminalRoutes">
            <parameter name="branch" type="int" sql-name="@branch"/>
            <!--parameter name="date" type="date" sql-name="@ddate"/-->
        </select>
        <save type="procedure" owner="spp" sql-name="TerminalRoutesSave">
            <parameter name="group_name" sql-name="@group_name" type="string"/>
            <parameter name="terminalID" sql-name="@terminalID" type="int"/>
        </save>
        <property name="xid" sql-compute="null"/>
        <property name="terminalID" type="int"/>
        <role name="branch" actor="branch"/>
    </concept>

    <concept name="branch-workday-result">
        <select type="procedure" owner="spp" sql-name="BranchDayResult4Web">
            <parameter name="branch-workday" type="int" sql-name="@branch_day"/>
        </select>
        <role name="branch-workday" actor="branch-workday"/>
    </concept>

    <concept name="branch-workday-coupon">
        <select type="procedure" owner="spp" sql-name="BranchDayCoupons4Web">
            <parameter name="branch-workday" type="int" sql-name="@branch_day"/>
        </select>
        <save type="procedure" owner="spp" sql-name="BranchDayCoupons4Web_save">
            <parameter name="xid" sql-name="@xid" type="int"/>
            <parameter name="coupon" sql-name="@coupon" type="int"/>
            <parameter name="branch-workday" sql-name="@branch_day" type="int"/>
            <parameter name="cnt" sql-name="@cnt" type="int"/>
        </save>
        <role name="branch-workday" actor="branch-workday"/>
        <property name="xid" key="true"/>
        <property name="cnt" type="int" />
        <property name="coupon_name" type="string"/>        
        <property name="coupon" type="int"/>        
        <property name="summ" type="decimal" sql-compute="cast(value*cnt as decimal(18,2))"/>
    </concept>

    <concept name="branch-workday">
        <select owner="dbo" sql-name="branch_day"/>
        <save owner="dbo" sql-name="branch_day"/>
        
        <role name="branch" actor="branch"/>
        <role name="cashier-main" actor="cashier" sql-name="head_cashier" label="Главный кассир"/>
        
        <property name="xid" />
        <property name="id" key="true" type="int" />
        <property name="date" type="date" sql-name="ddate" label="Дата"/>
        <property name="abs-date" type="date" sql-name="abs_ddate"  label="Дата АБС"/>
        <property name="closed" type="boolean" label="Закрыт"/>
        <property name="processed" type="boolean" label="Обработан"/>
        <property name="ccdistribed" type="boolean" label="Сотрудники закреплены"/>
    </concept>

    <concept name="encashment">
        <select type="procedure" owner="spp" sql-name="BranchEncashment4Web">
            <parameter name="branch" type="int" sql-name="@branch"/>
            <parameter name="branch-workday" sql-name="@branch_day" type="int"/>
        </select>
        <save type="procedure" owner="spp" sql-name="BranchEncashment4Web_save">
            <parameter name="catterminal" sql-name="@TerminalID" type="int"/>
            <parameter name="IncassID" sql-name="@IncassID" type="int"/>
            <parameter name="branch-workday" sql-name="@branch_day" type="int"/>
            <parameter name="xid" sql-name="@xid"/>
            <parameter name="cashed-fact" sql-name="@summ" type="decimal"/>
        </save>

        <role name="branch" actor="branch"/>
        <role name="catterminal" actor="catterminal" sql-name="pps_terminal"/>
        <role name="branch-workday" actor="branch-workday"/>

        <property name="terminal-id" type="int" sql-name="terminalid"/>
        <property name="xid"/>
        <property name="IncassID" type="int" sql-name="IncassID"/>
        <property name="datetime" type="datetime" sql-name="EventDateTime"/>
        <property name="cashed-system" sql-name="amount" type="decimal" format="0.00"/>
        <property name="cashed-fact" sql-name="summ" type="decimal" format="0.00"/>
    </concept>

</domain>
