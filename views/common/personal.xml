<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="personal-view" label="Уголок пользователя">
    
    <access role="it"/>
    <view-schema><form name="sysuser">
        
        <!-- внутри view-schema должна быть ровно одна form
           и она не может быть @is-set
           поэтому так странно слеплены
           названия элементов при форматировании
           зато экономия отступа -->
        
        <!-- в каждой БД полезно иметь таблицу из которой
           можно извлечь ровно одну строку -->
           
        <!-- лучше всегда в корень ставить sysuser
            и аналогичный концепт делать в каждой бд
            так как если не стазу, то потом как правило бывает надобится 
            извлекать зависищие от логина пользователя данные-->
            
        <!-- form/@name должно быть уникально в контесте view-schema -->
        <!-- (field|parameter)/@name должно быть уникально в контексте form -->
        
        <parameter name="name" label="Уважаемый"> <init with="username"/> </parameter>
        <parameter name="device-name"> <init with="device-name"/> </parameter>
        <parameter name="username"> <init with="username"/> </parameter>
        <parameter name="date" type="date"> <init with="today"/> </parameter>
        
        <field name="id" />
        
        <form name="cat-agent" label="Агент" what-label="Агента">
            
            <join name="sysuser" field="username"/>
            
            <field name="id" />
            <field name="name" />
            
            <form name="cat-salesman">
                
                <field name="id" />
                <field name="name" />
                
            </form>
            
        </form>
        
        <form name="personal-info" concept="payroll-person">
            <all-labeled-fields/>
            <!-- join для связи с родителем по объявленной в concept role не пишется -->
        </form>
        
        <secure role="it">
            
            <!-- то, что внутри secure
                видно только обладателю роли @role
                или вместо него @not-role
                - тогда эффект будет обратный -->
            
            <secure not-role="carantine">
                
                <!-- вложенность означает пересечение множеств
                    , т.е добавляет требования -->
                
                <form name="user-is-it" concept="sysuser">
                    
                    <join name="sysuser" field="id"/>
                    
                    <!-- иногда встречается глюк
                        когда некоторые комбинации форм не работают
                        если в них нет ни одного поля -->
                        
                    <field name="id"/>
                    
                    <form name="dbserver-console-log" concept="dbserver-console"
                        label="Консоль сервера БД"
                        is-set="true" preload="true" page-size="20"
                    ><all-labeled-fields/>
                        
                        <!-- @is-set - значит одижается множество строк -->
                        
                        <!-- @page-size - постраничный вывод
                            , пока не работает с MSSQL -->
                        
                        <!-- @preloаd - препятствует автоматике запроса данных
                            , они загрузятся только если в контексте будет
                            /*/userinput/command[@name=current()/self::xi:form/@name
                                or @name=concat('set-of-',current()/self::xi:form/@name)
                            ][text()='refresh']
                            
                            например, можно выполнить http-запрос:
                            ?@name_формы=refresh
                            
                            для форм-множеств нужно делать немного не так:
                            ?set-of-@name_формы=refresh
                            
                            смотри как это делается по кнопке
                            в /*/workflow/step[1]/option[@name='show-logs'] -->
                        
                        <order-by name="id" dir="desc"/>
                        
                    </form>
                    
                </form>
                
            </secure>
            
        </secure>
        
    </form></view-schema>
    
    <workflow>
        
        <step name="welcome-page" label="Добро пожаловать">
            
            <display>
                <print field="name" form="sysuser"/>
                <text>Это ваш личный кабинет</text>
            </display>
            
            <choise>
                <option name="show-personal" label="Персональные данные">
                    <command name="personal-view">personal-page</command>
                </option>
                <option name="show-logs" label="Серверные логи">
                    <command name="personal-view">logs-page</command>
                    <command name="set-of-dbserver-console-log">refresh</command>
                </option>
            </choise>
            
        </step>
        
        <step name="personal-page" hidden="true">
            
            <display>
                <print field="name" form="sysuser"/>
                <region class="tabs">
                    <region name="data" label="Данные">
                        <print form="personal-info" field="*"/>
                    </region>
                    <region name="help" label="Помощь">
                        <text>Если здесь ничего не показвается, значит нужно проапдейтить поле xmlgate.agent.person:</text>
                        <region collapsable="true" label="Посмотреть SQL ..." expanded-label="SQL">
                            <text>
                                update xmlgate.agent set person=(
                                    select person_id from employee join person where tabnum='?'
                                ) where name='?'
                            </text>
                            <text>Вместо ?? вставить номер пропуска и логин</text>
                        </region>
                    </region>
                </region>
            </display>
            
            <choise>
                <option name="show-data" label="На главную страницу">
                    <command name="personal-view">welcome-page</command>
                </option>
            </choise>
            
        </step>
        
        <secure role="it" ><secure not-role="carantine" ><step name="logs-page" hidden="true">
            
            <display>
                <region class="tabs">
                    <grid form="dbserver-console-log" label="Сервер БД">
                        <group>
                            <by form="dbserver-console-log" field="msg_database"/>
                        </group>
                    </grid>
                    <region label="?">
                        <text>Этот этап @hidden и not(choise)</text>
                        <text>,поэтому из него нельзя выйти обратно конпками</text>
                        <text>,но можно написать в адресе ?personal-view=welcome-page</text>
                        <text>или нажать "Обновить"</text>
                        <text>- по нажатию этой кнопки</text>
                        <text>программа переходит в ближайший снизу вверх step[not(@hidden)]</text>
                    </region>
                </region>
            </display>
            
        </step></secure></secure>
        
    </workflow>
    
</view-definition>