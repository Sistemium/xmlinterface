<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="personal-view" label="Уголок пользователя">
    
    <view-schema>
        
        <!--
            внутри view-schema должна быть ровно одна form
            и она не может быть @is-set
        -->
        
        <form name="sysuser" hidden="true">
            
            <parameter name="name" label="Уважаемый"> <init with="username"/> </parameter>
            <parameter name="device-name"> <init with="device-name"/> </parameter>
            <parameter name="username"> <init with="username"/> </parameter>
            <parameter name="date" type="date"> <init with="today"/> </parameter>
            
            <form name="cat-agent" label="Агент" what-label="Агента">
                
                <join name="sysuser" field="username"/>
                
                <field name="id" />
                <field name="name" />
                
                <form name="cat-salesman">
                    
                    <field name="id" />
                    <field name="name" />
                    
                </form>
                
            </form>
            
            <form name="personal-info" concept="payroll-person">
                <all-labeled-fields/>
                <!-- join для связи с родителем по объявленной в concept role не пишется -->
            </form>
            
            <secure role="it">
                <form name="recent-logs-from-asa-server" concept="dbserver-console"
                    is-set="true" preload="true" label="Консоль сервера БД"
                    page-size="20"
                >
                    <all-labeled-fields/>
                    <order-by name="id" dir="desc"/>
                </form>
            </secure>
            
        </form>
        
    </view-schema>
    
    <workflow>
        
        <step name="welcome-page" label="Добро пожаловать">
            
            <display>
                <print field="name" form="sysuser"/>
                <text>Это ваш личный кабинет</text>
            </display>
            
            <choise>
                <option name="show-personal" label="Персональные данные">
                    <command name="personal-view">personal-page</command>
                </option>
                <option name="show-logs" label="Серверные логи">
                    <command name="personal-view">logs-page</command>
                    <command name="set-of-recent-logs-from-asa-server">refresh</command>
                </option>
            </choise>
            
        </step>
        
        <step name="personal-page" hidden="true">
            
            <display>
                <print field="name" form="sysuser"/>
                <region class="tabs">
                    <region name="data" label="Данные">
                        <print form="personal-info" field="*"/>
                    </region>
                    <region name="help" label="Помощь">
                        <text>Если здесь ничего не показвается, значит нужно проапдейтить поле xmlgate.agent.person:</text>
                        <region collapsable="true" label="Посмотреть SQL ..." expanded-label="SQL">
                            <text>
                                update xmlgate.agent set person=(
                                    select person_id from employee join person where tabnum='?'
                                ) where name='?'
                            </text>
                            <text>Вместо ?? вставить номер пропуска и логин</text>
                        </region>
                    </region>
                </region>
            </display>
            
            <choise>
                <option name="show-data" label="На главную страницу">
                    <command name="personal-view">welcome-page</command>
                </option>
            </choise>
            
        </step>
        
        <secure role="it">
            <step name="logs-page" hidden="true">
                
                <display>
                    <region class="tabs">
                        <grid form="recent-logs-from-asa-server" label="Сервер БД">
                            <group>
                                <by form="recent-logs-from-asa-server" field="msg_database"/>
                            </group>
                        </grid>
                        <region label="?">
                            <text>Этот этап @hidden и not(choise)</text>
                            <text>,поэтому из него нельзя выйти обратно конпками</text>
                            <text>,но можно написать в адресе ?personal-view=welcome-page</text>
                        </region>
                    </region>
                </display>
                
            </step>
        </secure>
        
    </workflow>
    
</view-definition>