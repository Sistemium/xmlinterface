<?xml version="1.0"?>

<view-definition xmlns="http://unact.net/xml/xi" version="1.0" name="jbr-conversations" label="Диалоги джаббера">
    
    <access role="jabber"/>

    <view-schema><form name="jbr-user">
        
        <parameter name="name"> <init with="username"/> </parameter>
        <parameter name="device-name"> <init with="device-name"/> </parameter>
        <parameter name="date" type="date" editable="true" label="Дата"> <init with="today"/> </parameter>
        
        <field name="id" />
        
        <form name="jbr-conversation" is-set="true" page-size="50">
            
            <join name="jbr-user" field="date"/>
            
            <field name="id"/>
            <field name="with-name"/>
            <field name="start-time"/>
            <field name="end-time"/>
            
            <field name="conversant" sql-compute="null" label="Собеседник">
                <xpath-compute>
                    concat (
                        parent::xi:data
                        /xi:datum [@name='with-name']
                        , ' в '
                        , substring (
                            parent::xi:data
                            /xi:datum [@name='start-time']
                            , 12,5
                        )
                    )
                </xpath-compute>
            </field>
            
            <add-labeled-fields/>
            
            <sort field="start-time" form="jbr-conversation" dir="asc"/>
            
            <form name="jbr-message" is-set="true" page-size-="10">
                
                <field name="direction"/>
                <field name="ts" format="hh:mm"/>
                <field name="msg" hidden="true"/>
                
                <sort field="ts" form="jbr-message" dir="asc"/>
                
                <field name="from-msg" sql-compute="null" label="Мне">
                    <xpath-compute>
                        parent::xi:data [xi:datum[@name='direction' and text()='from']]
                        /xi:datum [@name='msg']
                    </xpath-compute>
                </field>
                
                <field name="from-msg" sql-compute="null" label="Я">
                    <xpath-compute>
                        parent::xi:data [xi:datum[@name='direction' and text()='to']]
                        /xi:datum [@name='msg']
                    </xpath-compute>
                </field>
                
            </form>
            
        </form>
        
    </form></view-schema>
    
    <workflow>
        
        <step name="s2" label="Все по-отдельности">
            
            <display>
                <input field="date" form="jbr-user"/>
                <region class="tabs">
                    <for-each form="jbr-conversation" label-field="conversant">
                        <grid form="jbr-message"/>
                    </for-each>
                </region>
            </display>
            
        </step>
        
        <step name="s1" label="Все на одном экране">
            
            <display>
                <input field="date" form="jbr-user"/>
                <grid form="jbr-message">
                    <group>
                        <by form="jbr-conversation" field="conversant"/>
                    </group>
                </grid>
            </display>
            
        </step>
        
    </workflow>
    
</view-definition>