<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="etc" label="Итоги платежных систем">
	
	<access role="it"/>
    
	<view-schema>
        <form name="dates">
        	<parameter name="date" type="date" label="Дата" editable="true">
        	   <init with="today"/>
            </parameter>
        	<field name="closed" type="boolean" label="Закрыто" editable="true"/>
            <form name="paysystemetc" label="Итог дня" is-set="true">
            	<field name="id"/>
            	<form name="paysystem" choise="paysystem-cache">
            	   <field name="name"  label="Платежная система"/>
            	   <field name="id"/>
        	    </form>
            	<field name="ddateb" label="С" type="date"/>
            	<field name="ddate" label="По" type="date"/>
            	<field name="summ" label="Сумма платежной системы" editable="true"/>
            	<field name="delta" label="Разница с платежами" />
            	<field name="checked" label="Статус" editable="true"/>
            	<field name="returned" label="Отмена" editable="true"/>
            	<field name="returned_bpa" label="БПА отмены" editable="true"/>
            	<join name="dates" field="date">
            	   <between>
                	   <start name="ddateb"/>
                	   <end sql-compute="dateadd(d,-1, dateadd(m, 1, cast(year(ddateb) as varchar)+'/'+cast(month(ddateb) as varchar)+'/01' ))"/>
            	   </between>
            	</join>
            	<order-by name="ddateb" dir="desc"/>
            	<order-by name="paysystem" dir="asc"/>
            </form>
        	<form name="paysystem-cache" concept="paysystem" is-set="true">
        	   <field name="name" label="Система"/>
        	   <field name="id"/>
    	    </form>
        </form>
    </view-schema>
    
    <workflow>
        <step>
            <display>
                <input form="dates" field="date"/>
                <input form="dates" field="closed"/>
                <grid form="paysystemetc"/>
            </display>
        </step>
    </workflow>

</view-definition>