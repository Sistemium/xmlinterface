<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="banktotals" label="Распределение банка">
    <view-schema>
        <form name="dates" label="Дата">
            <parameter name="date" type="date" label="Дата" editable="true"/>
            <field name="date" />
        	<field name="closed" type="boolean" editable="true" label="Распределено?"/>
        	<form name="paysystem-date" is-set="true">
            	<field name="id" />
            	<field name="bank-total" />
            	<field name="bpa-total" />
            	
            	<form name="paysystem" label="Платежная система">
                	<field name="id" />
                    <field name="name"/>
                    
                	<form name="paysystemetc">
            	        <field name="id"/>
                	    <field name="delta"/>
                    	<form name="delta-bpa" label="БПА корректировки" choise="bpa-cache">
                        	<field name="id" />
                            <field name="name" />
                        </form>
                        <join name="dates" field="date"/>
                        <where name="delta">
                            <not>0</not>
                        </where>
                	</form>    
                
                	<form name="bpa" is-set="true">
                    	<field name="id" />
                        <field name="name"  label="БПА" />
                        
                        <form name="bpatotal" build-blank="true">
                        	<field name="xid" />
                        	<field name="summ"  totals="sum" editable="true" when-null-then-delete="true"/>
                        	<join name="dates" field="date" />
                        	<join name="paysystem" />
                        </form>
                        
                        <join name="paysystem"/>
                        <where name="id" type="boolean">
                            <not>0 and [paysystem-date].[bpa_summ] &gt; 0</not>
                        </where>
                         
                    </form>
                    
                </form>

            	<join name="dates" field="date"/>
                <order-by name="paysystem" dir="asc"/>
            </form>
        	<form name="bpa-cache" concept="bpa" is-set="true">
            	<field name="id" />
                <field name="name" />
            </form>
        </form>
    </view-schema>
    <workflow>
        <step>
            <display>
                <input form="dates" field="date" />
                <input form="dates" field="closed" />
				<region class="tabs">
					<for-each form="paysystem-date" label-field="name">
						<print field="name" form="paysystem"/>
						<print field="bank-total" form="paysystem-date"/>
						<print field="delta" form="paysystemetc"/>
						<input form="delta-bpa"/>
						<!--print field="paysystem-total"-->
						<print field="bpa-total" form="paysystem-date"/>
						<grid form="bpa">
							<when field="closed" form="dates" equals="1">
								<disable/>
							</when>
						</grid>
					</for-each>
				</region>
            </display>
        </step>
    </workflow>
</view-definition>