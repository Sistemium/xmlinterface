<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="op-registers" label="Файловый процессинг" version="1.1">
	
    <view-schema><form name="op-agent"> 
		
		<parameter name="name"><init with="username"/></parameter>
		
		<form name="pc-account" expect-choise="true" choise-style="table">
            
            <field name="id"/>
            <field name="name"/>
            
            <form name="pc-account-register-aggregate" concept="op-payment-register"
                  no-preload="true" constrain-parent="true"
            >   <field name="id" aggregate="count" label="Всего реестров"/>
            </form>
            
            <form name="op-payment-register" is-set="true" deletable="true">
                <field name="id"/>
                <field name="xid"/>
                <add-labeled-fields />
                <order-by name="date" dir="desc"/>
            </form>
            
            <form name="new-register" concept="op-payment-register" preload="true">
                <parameter name="blank-number">
                    <init with="const">1</init>
                </parameter>
                <field name="id"/>
                <field name="date"/>
                <form name="just-registered-payments" is-set="true" concept="op-payment-process" label="Платежи реестра" page-size="10">
                    <field name="payment" label="ОП-ИД"/>
                    <field name="summ"/>
                    <field name="account"/>
                    <field name="extra"/>
                    <field name="ts"/>
                    <order-by name="ts" dir="desc"/>
                </form>
            </form>
            
            <form name="register-detail" concept="op-payment-register" parent-sql-name="pcaccount">
                <parameter name="register-detail-xid" modifiable="true" property="xid"/>
                <field name="id"/>
                <field name="date"/>
                <field name="cts"/>
                <field name="ts"/>
                <field name="processed" editable="true"/>
                <form name="register-detail-process" is-set="true" concept="op-payment-process" page-size="10">
                    <field name="id"/>
                    <field name="payment" label="ОП-ИД"/>
                    <field name="summ"/>
                    <field name="account"/>
                    <field name="extra"/>
                    <field name="ts"/>
                    <order-by name="ts" dir="desc"/>
                </form>
            </form>
            
        </form>
        
    </form></view-schema>
    
    <workflow>
        
        <reusables>
            <option name="to-registers-browse" label="К списку реестров">
                <command name="op-registers">register-browse</command>
                <command name="set-of-op-payment-register">refresh</command>
            </option>
        </reusables>
        
        <step name="register-browse">
            <display>
                <grid form="op-payment-register">
                    <option label="...">
                        <command name="register-detail-xid" xpath-compute="xi:datum[@name='xid']"/>
                        <command name="op-registers">register-detail-view</command>
                    </option>
                </grid>
            </display>
            <choise>
                <option name="make-new-register" label="Новый реестр">
                    <command name="op-registers">new-register-view</command>
                    <command name="new-register">refresh</command>
                </option>
            </choise>
        </step>
        
        <step name="new-register-view" hidden="true" label="Новый реестр">
            <display>
                <print form="new-register" field="*"/>
                <grid form="just-registered-payments"/>
            </display>
            <choise>
                <option reuse="to-registers-browse"/>
            </choise>
        </step>
        
        <step name="register-detail-view" hidden="true" label="Платежи реестра">
            <display>
                <print form="register-detail" field="date"/>
                <print form="register-detail" field="ts"/>
                <print form="register-detail" field="cts"/>
                <input form="register-detail" field="processed"/>
                <grid form="register-detail-process"/>
            </display>
            <choise>
                <option reuse="to-registers-browse"/>
            </choise>
        </step>
        
    </workflow>
    
</view-definition>