<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="ua-accounts" label="Аккаунты UA">
    
    <view-schema><form name="UA">
        
        <parameter name="date" type="date"> <init with="today"/> </parameter>
        
        <parameter name="searcher" label="Поиск" editable="true" optional="true"/>
        
        <form name="ua-account" is-set="true" page-size="10" deletable-="true" toggle-edit-off="true">
            
            <add-labeled-fields/>
            
            <field name="code" editable="true"/>
            
            <order-by name="ts" dir="desc"/>
            
            <form name="ua-account-provider-agg" concept="ua-account-provider">
                <field name="id" aggregate="count" label="Связано аккаунтов"/>
            </form>
            
            <join name="UA" field="searcher"/>
            
        </form>
        
        <form name="ua-account-details" concept="ua-account">
            
            <parameter name="account-to-detail-id" type="int" modifiable="true" property="id"/>
            
            <field name="code" editable="true"/>
            
            <add-labeled-fields/>
            
            <form name="ua-account-provider-agg" concept="ua-account-provider">
                <field name="id" aggregate="count" label="Связано аккаунтов"/>
            </form>
            
            <form name="ua-account-role" is-set="true" extendable="true" deletable="true">
                <field name="xid"/>
                <form name="ua-account-role-name" concept="ua-role" role="ua-role" choise="ua-role-cache" label="Роль">
                    <field name="id"/>
                    <field name="name"/>
                </form>
                <field name="data" editable="true"/>
            </form>
            
            <form name="ua-account-provider" is-set="true">
                <form name="ua-account-provider-name" concept="ua-provider">
                    <field name="name" label="Провайдер"/>
                </form>
                <field name="data"/>
            </form>
            
        </form>
        
        <form name="ua-role-cache" concept="ua-role" is-set="true">
            
            <field name="id"/>
            <field name="name" label="Роль"/>
            
        </form>
        
    </form></view-schema>
    
    <workflow name="ua-accounting">
        
        <step name="index">
            
            <display>
                <input form="UA" field="searcher"/>
                <grid form="ua-account" label="Аккаунты">
                    <option name="show-account-provider-data" label="...">
                        <command name="account-to-detail-id" xpath-compute="
                            xi:datum[@name='id']
                        "/>
                        <command name="ua-accounting">account-details-page</command>
                    </option>
                </grid>
            </display>
            
        </step>
        
        <step name="account-details-page" hidden="true">
            
            <display>
                <region>
                    <print form="ua-account-details" field="*"/>
                </region>
                <region class="tabs">
                    <grid form="ua-account-role" label="Роли"/>
                    <grid form="ua-account-provider" label="Данные провадеров"/>
                </region>
            </display>
            
            <choise>
                <option reuse="to-index"/>
            </choise>
            
        </step>
        
        <reusables>
            
            <option name="to-index" label="К таблице аккаунтов">
                <command name="ua-accounting">index</command>
            </option>
            
        </reusables>
        
    </workflow>
    
</view-definition>