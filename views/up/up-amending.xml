<?xml version="1.0" ?>

<view-definition xmlns="http://unact.net/xml/xi" name="up-amending" label="Корректировка успешных платежей на карты">
	
	<access role="beta"/>
    
    <view-schema> <form name="op-agent"> 
		
		<parameter name="name">
			<init with="username"/>
		</parameter>
		
		<field name="id"/>
		
		<form name="up-client" expect-choise="optional" label="Клиент" choise-style="table">
			
			<field name="id"/>
			<field name="name" label="Клиент"/>
            
            <form name="up-file-type">
                <field name="id"/>
                <where name="code">bank</where>
                <form name="payment-search" concept="op">
                    
                    <parameter name="accounts" label="Реквизиты" editable="true" optional="true"/>
                    
                    <form name="up-file-payment" is-set="true" page-size="10" label="Клиентские платежи">
                        
                        <join name="up-client" />
                        <join name="up-file-type"  />
                        
                        <where name="op-error">0</where>
                        
                        <field name="id"/>
                        
                        <!--field name="to-claim" type="string" label="Инциденты">
                            <sql-compute>
                                if not exists (select * from op.[payment claim] where prepayment=[up-file-payment].id)
                                then 'Зарегистрировать'
                                endif
                            </sql-compute>
                            <navigate to="bank-payment-claim">
                                
                                <pull name="file-payment" field="id" form="up-file-payment"/>
                                
                                <pull name="initial-account" field="account" form="up-file-payment"/>
                                
                                <pull name="initial-bik" field="extra" form="up-file-payment" xpath="*[@name='bik']"/>
                                <pull name="initial-firstname" field="extra" form="up-file-payment" xpath="*[@name='firstname']"/>
                                <pull name="initial-middlename" field="extra" form="up-file-payment" xpath="*[@name='middlename']"/>
                                <pull name="initial-lastname" field="extra" form="up-file-payment" xpath="*[@name='lastname']"/>
                                
                            </navigate>
                        </field-->
                        
                        <field name="ts" format="smalltime"/>                    
                        <field name="summ"/>
                        <field name="account"/>
                        <field name="extra"/>
                        
                        <order-by name="ts" dir="desc"/>
                        
                        <join name="payment-search" field="accounts" />
                        
                    </form>
                </form>
                
                <form name="payment-to-amend" concept="up-file-payment" what-label="Платеж">
                    
                    <parameter name="payment-to-amend-id" property="id" modifiable="true"/>
                    
                    <field name="id"/>
                    <field name="extra"/>
                    
                    <field name="account"/>
                    
                    <field name="extra-bik" label="БИК">
                        <sql-compute>null</sql-compute>
                        <xpath-compute>../*[@name='extra']/*[@name='bik']</xpath-compute>
                    </field>
                    <field name="extra-contract" label="Карта/договор">
                        <sql-compute>null</sql-compute>
                        <xpath-compute>../*[@name='extra']/*[@name='contract']</xpath-compute>
                    </field>
                    <field name="extra-lastName" label="Фамилия">
                        <sql-compute>null</sql-compute>
                        <xpath-compute>../*[@name='extra']/*[@name='lastname']</xpath-compute>
                    </field>
                    <field name="extra-firstName" label="Имя">
                        <sql-compute>null</sql-compute>
                        <xpath-compute>../*[@name='extra']/*[@name='name']</xpath-compute>
                    </field>
                    <field name="extra-middleName" label="Отчество">
                        <sql-compute>null</sql-compute>
                        <xpath-compute>../*[@name='extra']/*[@name='middlename']</xpath-compute>
                    </field>
                    
                    <field name="payment-date" type="string"
                       sql-compute="date(cts)+1"
                    />
                    
                    <form name="claim" concept="up-file-payment-claim" build-blank="true" parent-sql-name="prepayment">
                        
                        <field name="xid"/>
                        
                        <field name="phoneNumber" editable="true" />
                        <field name="account" editable="true" autofill="account" autofill-form="payment-to-amend"/>
                        <field name="contract" editable="true" autofill="extra-contract" autofill-form="payment-to-amend"/>
                        <field name="bik" editable="true" autofill="extra-bik" autofill-form="payment-to-amend"/>
                        <field name="lastName" editable="true" autofill="extra-lastName" autofill-form="payment-to-amend"/>
                        <field name="firstName" editable="true" autofill="extra-firstName" autofill-form="payment-to-amend"/>
                        <field name="middleName" editable="true" autofill="extra-middleName" autofill-form="payment-to-amend"/>
                        
                        <field name="terminal" modifiable="true">
                            <xpath-compute>
                                xi:isnull( current(), ancestor::xi:view-data[1]//*[@name='amendment-terminal']/*[@name='id'] )
                            </xpath-compute>
                        </field>
                        
                    </form>
                    
                    <form name="payment-reciept" concept="op-payment" is-set="true">
                        <field name="summ"/>
                        <field name="summTerminal"/>
                        <field name="terminal-fee"/>
                        <field name="printed-number" type="string"
                            label="Номер чека"
                            sql-compute="string(replace(replace(replace(replace(convert(varchar(23),cts,121),'-',''),':',''),' ',''),'.',''),'203150')"
                        />
                    </form>
                    
                </form>
                
                <form name="amendment-terminal" concept="up-file-payment-claim-terminal">
                    
                    <parameter name="payment-date" modifiable="true" property="date"/>
                    <parameter name="payment-summ" modifiable="true" property="summ"/>
                    
                    <field name="id" label="ИД терминала"/>
                    
                    <form name="amendment-terminal-details" concept="bank-terminal">
                        <field name="address" label="Адрес терминала"/>
                    </form>
                    
                </form>
                
            </form>
            
		</form>
		
    </form> </view-schema>
	
	<workflow>
		
		<step name="payment-search" label="Поиск платежа">
			<display>
				<input form="up-client" />
				<input form="payment-search" field="accounts"/>
				<grid form="up-file-payment" hide-empty="true" label="Выберите платеж">
					<option label="Выбрать">
						<command name="payment-to-amend-id" xpath-compute="xi:datum[@name='id']" />
						<command name="payment-date" xpath-compute="xi:string-to-date(xi:datum[@name='ts'])" />
						<command name="payment-summ" xpath-compute="xi:datum[@name='summ']" />
						<command name="up-amending">amendment-details</command>
					</option>
				</grid>
			</display>
			<validate>
				<nonempty form="payment-to-amend"/>
			</validate>
		</step>
		
		<step name="amendment-details" label="Корректировка платежа">
			
			<display>
				<print form="up-client" field="name"/>
				<input form="claim" field="phoneNumber"/>
				<region label="Корректировочная информация">
					<input form="claim" field="account"/>
					<when form="payment-to-amend" field="extra-contract">
						<input form="claim" field="contract"/>
					</when>
					<input form="claim" field="bik"/>
					<input form="claim" field="lastName"/>
					<input form="claim" field="firstName"/>
					<input form="claim" field="middleName"/>
				</region>
				<region label="Исходная информация">
					<print form="payment-to-amend" field="account"/>
					<print form="payment-to-amend" field="extra-contract"/>
					<print form="payment-to-amend" field="extra-bik"/>
					<print form="payment-to-amend" field="extra-lastName"/>
					<print form="payment-to-amend" field="extra-firstName"/>
					<print form="payment-to-amend" field="extra-middleName"/>
				</region>
			</display>
			
			<validate>
				<nonempty form="claim" field="phoneNumber"/>
				<nonempty form="claim" field="account"/>
				<when form="payment-to-amend" field="extra-contract">
					<nonempty form="claim" field="contract"/>
				</when>
				<nonempty form="claim" field="bik"/>
				<nonempty form="claim" field="lastName"/>
				<nonempty form="claim" field="firstName"/>
				<nonempty form="claim" field="middleName"/>
			</validate>
			
		</step>
		
		<step name="amendment-reciepts" label="Регистрация заявления">
			
			<display>
				<print form="up-client" field="name"/>
				<region class="tabs">
					<region label="Скорректированная информация">
						<print form="claim" field="*"/>
						<print form="amendment-terminal" field="id"/>
						<print form="amendment-terminal-details" field="address"/>
					</region>
					<grid form="payment-reciept" label="Чеки"/>
				</region>
			</display>
			
			<choise>
				<option label="Завершить оформление">
					<command name="save"/>
					<command name="refresh"/>
				</option>
			</choise>
			
		</step>
		
	</workflow>
	
</view-definition>