<?xml version="1.0" ?>

<view-definition xmlns="http://unact.net/xml/xi" name="up-amending" label="Корректировка платежей">
	
	<access role="beta"/>
    
    <view-schema> <form name="op-agent"> 
		
		<parameter name="name">
			<init with="username"/>
		</parameter>
		
		<field name="id"/>
		
		<form name="up-client" expect-choise="forced" label="Клиент" choise-style="table">
			
			<field name="id"/>
			<field name="name" label="Клиент"/>
            
            <form name="payment-search" concept="up-client">
                
                <join name="up-client" field="id" />
                
                <field name="id"/>
                
                <parameter name="accounts" label="Реквизиты" editable="true" optional="true"/>
                
                <form name="up-file-payment" is-set="true" page-size="10"
                    label="Клиентские платежи">
                    
                    <!--form name="up-file" constrain-parent="true">
                        <join name="payment-search" />
                    </form-->
                    
                    <form name="up-file-payment-error" concept="op-error" no-preload="true">
                        <field name="id"/>
                        <field name="name" label="Cтатус" />
                        <where name="id"><not>0</not></where>
                    </form>
                    
                    <field name="id"/>
                    
                    <field name="ts" format="smalltime"/>                    
                    <field name="summ"/>
                    <field name="account"/>
                    <field name="extra"/>
                    
                    <order-by name="ts" dir="desc"/>
                    
                    <join name="payment-search" field="accounts" />
                    
                </form>
                
                <form name="payment-to-ammend" concept="up-file-payment" what-label="Платеж">
                    <parameter name="payment-to-ammend-id" property="id" modifiable="true"/>
                    <add-labeled-fields/>
                    
                    <field name="id"/>
                    
                    <field name="payment-date" type="string"
                       sql-compute="date(cts)+1"
                    />
                    
                    <form name="claim" concept="up-file-payment-claim" build-blank="true">
                        <field name="phone-number" editable="true" label="Номер телефона"
                           sql-compute="null"
                        />
                        <field name="fio" editable="true" label="ФИО"
                           sql-compute="null"
                        />
                        <field name="correct-account" type="text" editable="true" label="Правильные реквизиты"
                           sql-compute="string(account, ',', extra)"
                        />
                    </form>
                    
                    <form name="payment-reciept" concept="op-payment" is-set="true">
                        <field name="summ"/>
                        <field name="summTerminal"/>
                        <field name="terminal-fee"/>
                        <field name="printed-number" type="string"
                            label="Номер чека"
                            sql-compute="string(replace(replace(replace(replace(convert(varchar(23),cts,121),'-',''),':',''),' ',''),'.',''),'203150')"
                        />
                    </form>
                    
                </form>
                
                <form name="amendment-terminal" concept="up-file-payment-claim-terminal">
                    <parameter name="payment-date" modifiable="true" property="date"/>
                    <parameter name="payment-summ" modifiable="true" property="summ"/>
                    
                    <field name="id" label="ИД терминала"/>
                    
                    <form name="amendment-terminal-details" concept="bank-terminal">
                        <field name="address"/>
                    </form>
                    
                </form>
                
            </form>
            
		</form>
		
    </form> </view-schema>
	
	<workflow>
		
        <step name="payment-search" label="Поиск платежа">
			<display>
				<input form="up-client" />
                <input form="payment-search" field="accounts"/>
				<grid form="up-file-payment" hide-empty="true" label="Выберите платеж">
					<option label="Выбрать">
						<command name="payment-to-ammend-id" xpath-compute="xi:datum[@name='id']" />
						<command name="payment-date" xpath-compute="xi:string-to-date(xi:datum[@name='ts'])" />
						<command name="payment-summ" xpath-compute="xi:datum[@name='summ']" />
                        <command name="up-ammending">amendment-details</command>
					</option>
				</grid>
			</display>
            <validate>
                <nonempty form="payment-to-ammend"/>
            </validate>
		</step>
		
        <step name="amendment-details" label="Корректировка платежа">
			<display>
                <print form="up-client" field="name"/>
                <region class="tabs">
                    <region label="Корректировочная информация">
                        <input form="claim" field="phone-number"/>
                        <input form="claim" field="fio"/>
                        <input form="claim" field="correct-account"/>
                    </region>
                    <region label="Исходная информация">
                        <print form="payment-to-ammend" field="account"/>
                        <print form="payment-to-ammend" field="extra"/>
                        <print form="amendment-terminal" field="id"/>
                        <print form="amendment-terminal-details" field="address"/>
                    </region>
                </region>
            </display>
            <validate>
                <nonempty form="claim" field="phone-number"/>
                <nonempty form="claim" field="fio"/>
                <nonempty form="claim" field="correct-account"/>
            </validate>
        </step>
        
        <step name="amendment-reciepts" label="Чеки платежа">
			<display>
                <print form="up-client" field="name"/>
                <region class="tabs">
                    <grid form="payment-reciept" label="Чеки"/>
                    <region label="Корректировочная информация">
                        <print form="claim" field="phone-number"/>
                        <print form="claim" field="fio"/>
                        <print form="claim" field="correct-account"/>
                    </region>
                    <region label="Исходная информация">
                        <print form="payment-to-ammend" field="account"/>
                        <print form="payment-to-ammend" field="extra"/>
                        <print form="amendment-terminal" field="id"/>
                        <print form="amendment-terminal-details" field="address"/>
                    </region>
                </region>
            </display>
            <choise>
                <option label="Завершить оформление">
                    <command name="save"/>
                    <command name="refresh"/>
                    <!--command name="up-amending">payment-search</command-->
                </option>
            </choise>
        </step>
        
    </workflow>
	
</view-definition>

