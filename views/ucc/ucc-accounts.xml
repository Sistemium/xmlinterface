<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="ucc-accounts" label="Счета UCC">
    
    <view-schema><form name="UCC">
        
        <parameter name="date" type="date"> <init with="today"/> </parameter>
        
        <form name="ucc-account-create" build-blank="true" new-only="true" concept="ucc-account">
            <field name="xid"/>
            <field name="name" editable="true"/>
            <field name="code" editable="true"/>
        </form>
        
        <parameter name="searcher" label="Поиск" editable="true" optional="true"/>
        
        <form name="ucc-account" is-set="true" page-size="12" toggle-edit-off-="true" deletable="true">
            
            <add-labeled-fields/>
            <field name="id"/>
            <field name="code" hidden="true"/>
            
            <!--form name="ucc-account-income-agg" concept="ucc-income" label="Сводка приходов">
                <field name="id" aggregate="count" label="Кол-во приходов"/>
                <field name="summ" aggregate="sum" label="Сумма приходов"/>
            </form-->
            
            <order-by name="name" dir="asc"/>
            
            <join name="UCC" field="searcher"/>
            
        </form>
        
        <form name="ucc-account-details" concept="ucc-account">
            
            <parameter name="account-to-detail-id" type="int" modifiable="true" property="id"/>
            
            <field name="id"/>
            
            <add-labeled-fields/>
            
            <form name="ucc-account-expense-blank" concept="ucc-expense" label="Новый расход"
                parent-sql-name="client" new-only="true" build-blank="true"
            >
                
                <field name="xid"/>
                
                <field name="date" editable="true">
                    <init with="today"/>
                </field>
                
                <field name="summ" editable="true"/>
                
                <form name="ucc-account-expense-bank-account"
                      concept="ucc-bank-account"
                      choise="ucc-account-bank-account"
                      choise-label="account-number"
                      role="ucc-bank-account">
                    <field name="id"/>
                    <field name="name"/>
                </form>
                
            </form>
            
            <form name="ucc-account-blocked" concept="ucc-expense">
                
                <field name="summ" aggregate="sum" label="Заблокировано средств"/>
                <where name="isFinal">
                    <not>1</not>
                </where>
                
            </form>
            
            <field name="funds-available" type="decimal" sql-compute="0.0" label="Доступно средств">
                <xpath-compute>
                    - xi:isnull(../xi:data[@name='ucc-account-blocked']/xi:datum[@name='summ'],0)
                    + ../xi:datum[@name='funds']
                </xpath-compute>
            </field>
            
            <form name="ucc-account-income-blank" concept="ucc-income" label="Новый приход на счет"
                parent-sql-name="client" new-only="true" build-blank="true"
            >
                
                <field name="xid"/>
                
                <field name="date" editable="true">
                    <init with="today"/>
                </field>
                
                <field name="summ" editable="true"/>
                
                <form name="ucc-account-income-blank-agent" concept="ucc-agent" choise="ucc-agent-cache" role="ucc-agent" label="Источник">
                    <field name="id"/>
                    <field name="name"/>
                </form>
                
            </form>
            
            <form name="ucc-account-income" concept="ucc-income" label="Приходы" is-set="true" page-size="5" >
                <add-labeled-fields/>
                <form name="ucc-income-agent" concept="ucc-agent">
                    <field name="name" label="Источник"/>
                </form>
                <order-by name="date" dir="desc"/>
            </form>
            
            <form name="ucc-account-expense" concept="ucc-expense" label="Расходы"
                is-set="true" page-size="5" deletable="true"
            >
                <field name="id"/>
                <add-labeled-fields/>
                <order-by name="date" dir="desc"/>
            </form>
            
            <form
                name="ucc-bank-account-create" concept="ucc-bank-account"
                new-only="true" build-blank="true"
                parent-sql-name="client"
            >
                
                <field name="xid"/>
                
                <field name="fname" editable="true"/>
                <field name="mname" editable="true"/>
                <field name="lname" editable="true"/>
                
                <field name="bik" editable="true"/>
                <field name="account-number" editable="true"/>
                <field name="extra-number" editable="true"/>
                
                <field name="op-service" use-with-insert="true">
                    <init with="const">741745</init>
                </field>
                
                <form name="ucc-bank-account-create-agent"
                    concept="ucc-agent" choise="ucc-agent-cache" role="ucc-agent"
                    label="Проводить через"
                >
                    <field name="id"/>
                    <field name="name"/>
                </form>
                
            </form>
            
            <form name="ucc-account-bank-account" concept="ucc-bank-account"
                label="Реквизиты" is-set="true" page-size="5"
                deletable="true"
            >
                <add-labeled-fields/>
                <field name="id"/>
                <field name="xid"/>
                <order-by name="ts" dir="desc"/>
                <form name="ucc-bank-account-agent" concept="ucc-agent">
                    <field name="name" label="Проводник"/>
                </form>
            </form>
            
        </form>
        
        <form name="ucc-agent-cache" concept="ucc-agent" is-set="true">
            <field name="id"/>
            <field name="name"/>
        </form>
        
    </form></view-schema>
    
    <workflow name="ucc-accounting">
        
        <step name="index-page">
            
            <display>
                <input form="UCC" field="searcher"/>
                <grid form="ucc-account" label="Счета" deletable="false">
                    <option reuse="detail-account"/>
                </grid>
            </display>
            
            <choise>
                <option reuse="create-account"/>
            </choise>
            
        </step>
        
        <step name="account-details-page" hidden="true" label="Детализация счета">
            
            <display>
                <region class="hbox">
                    
                    <region class="sidebar">
                        
                        <input form="UCC" field="searcher"/>
                        <grid form="ucc-account" deletable="false">
                            <option name="change-detailed-account" label="Выбрать">
                                <command name="account-to-detail-id" xpath-compute="
                                    xi:datum[@name='id']
                                "/>
                            </option>
                            <columns>
                                <column field="name" label="Счет"/>
                            </columns>
                        </grid>
                        
                    </region>
                    
                    <region class="flex">
                        
                        <region>
                            <print form="ucc-account-details" field="*"/>
                            <print form="ucc-account-blocked" field="*"/>
                        </region>
                        
                        <region class="tabs">
                            <grid form="ucc-account-income" label="Недавние приходы"/>
                            <grid form="ucc-account-expense" label="Недавние расходы" hide-empty="true"/>
                            <grid form="ucc-account-bank-account" label="Банковские реквизиты" hide-empty="true">
                                <columns>
                                    <column field="bik"/>
                                    <column label="Счет">
                                        <print field="account-number"/>
                                        <print field="extra-number"/>
                                        <print field="op-service"/>
                                        <print field="name" form="ucc-bank-account-agent"/>
                                    </column>
                                    <column label="ФИО">
                                        <print field="fname"/>
                                        <print field="mname"/>
                                        <print field="lname"/>
                                    </column>
                                </columns>
                            </grid>
                        </region>
                        
                    </region>
                    
                </region>
            </display>
            
            <choise>
                <option reuse="to-index"/>
                <option reuse="create-bank-account"/>
                <option reuse="create-income"/>
                <option reuse="create-expense"/>
            </choise>
            
        </step>
        
        <step name="create-account-page" hidden="true" label="Добавление счета">
            
            <display>
                <region>
                    <input form="ucc-account-create" field="*"/>
                </region>
            </display>
            
            <choise>
                <option name="commit-account-creation" label="Сохранить">
                    <command name="ucc-account-create">save</command>
                    <command name="set-of-ucc-account">refresh</command>
                    <command name="ucc-accounting">index-page</command>
                </option>
                <option name="cancel-account-creation" label="Отменить">
                    <command name="ucc-account-create">refresh</command>
                    <command name="ucc-accounting">index-page</command>
                </option>
            </choise>
            
        </step>
        
        <step name="create-bank-account-page" hidden="true" label="Добавление реквизитов">
            
            <display>
                <region>
                    <input form="ucc-bank-account-create" field="*"/>
                    <input form="ucc-bank-account-create-agent"/>
                </region>
            </display>
            
            <choise>
                <option label="Сохранить" reuse="to-detail">
                    <command name="ucc-bank-account-create">save</command>
                    <command name="set-of-ucc-account-bank-account">refresh</command>
                </option>
                <option reuse="to-detail">
                    <command name="ucc-bank-account-create">refresh</command>
                </option>
            </choise>
            
        </step>
        
        <step name="create-income-page" hidden="true" label="Новый приход">
            
            <display>
                <region>
                    <print form="ucc-account-details" field="name" label="На счет" class="label"/>
                    <input form="ucc-account-income-blank-agent" label="Источник"/>
                    <input form="ucc-account-income-blank" field="*"/>
                </region>
            </display>
            
            <choise>
                <option label="Сохранить" reuse="to-detail">
                    <command name="ucc-account-income-blank">save</command>
                    <command name="set-of-ucc-account-income">refresh</command>
                </option>
                <option reuse="to-detail">
                    <command name="ucc-account-income-blank">refresh</command>
                </option>
            </choise>
            
        </step>
        
        <step name="create-expense-page" hidden="true" label="Новый расход">
            
            <display>
                <region>
                    <print form="ucc-account-details" field="name" label="На счет" class="label"/>
                    <input form="ucc-account-expense-bank-account" label="Реквизиты"/>
                    <input form="ucc-account-expense-blank" field="*"/>
                </region>
            </display>
            
            <choise>
                <option label="Сохранить" reuse="to-detail">
                    <command name="ucc-account-expense-blank">save</command>
                    <command name="set-of-ucc-account-expense">refresh</command>
                    <command name="ucc-account-blocked">refresh</command>
                </option>
                <option reuse="to-detail">
                    <command name="ucc-account-expense-blank">refresh</command>
                </option>
            </choise>
            
        </step>
        
        <reusables>
            
            <option name="create-account" label="Добавить счет">
                <command name="ucc-accounting">create-account-page</command>
                <command name="ucc-account-create">refresh</command>
            </option>
            
            <option name="create-bank-account" label="Добавить реквизиты">
                <command name="ucc-accounting">create-bank-account-page</command>
                <command name="ucc-bank-account-create">refresh</command>
            </option>
            
            <option name="create-income" label="Новый приход">
                <command name="ucc-accounting">create-income-page</command>
                <command name="ucc-account-income-blank">refresh</command>
            </option>
            
            <option name="create-expense" label="Новый расход">
                <command name="ucc-accounting">create-expense-page</command>
                <command name="ucc-account-expense-blank">refresh</command>
            </option>
            
            <option name="to-index" label="К таблице счетов">
                <command name="ucc-accounting">index-page</command>
            </option>
            
            <option name="to-detail" label="Отменить">
                <command name="ucc-accounting">account-details-page</command>
            </option>
            
            <option name="detail-account" label="...">
                <command name="account-to-detail-id" xpath-compute="
                    xi:datum[@name='id']
                "/>
                <command name="ucc-accounting">account-details-page</command>
            </option>
            
        </reusables>
        
    </workflow>
    
</view-definition>