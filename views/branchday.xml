<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="branch-workday-results" label="Итоги дня" pipeline="views">
    <view-schema>
        <form name="branch" label="Отделение" expect-choise="true">
            <parameter name="username" type="string" label="Логин оператора"/>
            <field name="name" label="Отделение"/>
            <field name="id" />
            <form name="branch-workday" label="Рабочий день отделения">
                <parameter name="date" type="date" editable="true" label="Рабочий день">
                    <init with="today"/>
                </parameter>
                <field name="id" />
                <field name="xid" />
                <field name="date" />
                <field name="abs-date" editable="true"/>
                <field name="closed" label="Закрыт" editable="true"/>
                <field name="processed" label="Обработан" editable="true"/>
                <field name="ccdistribed" label="Сотрудники распределены" editable="true"/>
                <field name="totalCash" type="decimal" label="Сумма подтвержденных инкассаций"
		       sql-compute="(select sum(summ) from dbo.encashment where branch_day=[branch-workday].id)"/>
                <form name="cashier-main" choise="cashier-cache">
                    <field name="id" />
                    <field name="name" />
                </form>
                <form name="branch-workday-coupon" label="Купюры" is-set="true">
                    <field name="xid" key="true"/>
                	<field name="coupon_name" label="Номинал"/>
                	<field name="coupon" key="true"/>
                	<field name="cnt" label="Кол-во" editable="true" totals="sum"/>
                	<field name="summ" label="Сумма" totals="sum"/>
                </form>
                <form name="branch-workday-result" label="Итог дня" is-set="true">
                	<field name="name" label="Показатель"/>
                	<field name="value" label="Значение" type="int"/>
                	<natural-order/>
                </form>
                <form name="branch-workday-route" label="Маршруты" is-set="true" deletable="true">
                    <field name="xid"/>
                	<form name="branch-route">
                	   <field name="name" label="Название"/>
                	   <field name="description" label="Описание"/>
                	   <field name="id"/>
                	</form>
                	<form name="collector" label="Инкассатор" choise="collector-cache">
                	   <field name="name"/>
                	   <field name="id"/>
                	</form>
                </form>
                <form name="branch-workday-cashier" label="Кассиры" is-set="true" extendable="true" deletable="true">
                    <field name="xid"/>
                	<form name="cashier" label="Кассир" choise="cashier-cache">
                	   <field name="name"/>
                	   <field name="id"/>
                	</form>
                </form>
            	<!--join name="branch" field="date"/-->
            </form>
            <form name="cashier-cache" concept="cashier" is-set="true">
                <field name="id"/>
                <field name="name"/>
            </form>
        	<form name="collector-cache" concept="collector" is-set="true">
        	   <field name="id"/>
        	   <field name="name"/>
        	</form>
        </form>
    </view-schema>
    <workflow>
        <step label="Сводка">
            <display>
                <input form="branch" />
                <input form="branch-workday" field="date"/>
                <input form="branch-workday" field="abs-date"/>
                <input form="branch-workday" field="closed"/>
                <input form="branch-workday" field="processed"/>
                <input form="branch-workday" field="ccdistribed"/>
                <grid form="branch-workday-result"/>
            </display>
        </step>
        <step label="Купюры">
            <display>
                <print form="branch" field="name"/>
                <input form="branch-workday" field="date"/>
                <print form="branch-workday" field="totalCash"/>
                <grid form="branch-workday-coupon" label="Купюры"/>
            </display>
        </step>
        <step label="Сотрудники">
            <display>
                <print form="branch" field="name"/>
                <input form="branch-workday" field="date"/>
                <input form="cashier-main" />
                <grid form="branch-workday-route" label="Маршруты"/>
                <grid form="branch-workday-cashier" label="Кассиры"/>
            </display>
        </step>
    </workflow>
</view-definition>