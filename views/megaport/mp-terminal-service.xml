<?xml version="1.0"?>

<view-definition version="1.0" xmlns="http://unact.net/xml/xi"
    name="mp-terminal-service" label="Обслуживание терминалов"
>
    <!-- providing terminal service -->
    <view-schema><form name="sysuser">
        
        <parameter name="name"> <init with="username"/> </parameter>
        <parameter name="username"> <init with="username"/> </parameter>
        <parameter name="device-name"> <init with="device-name"/> </parameter>
        <parameter name="date" type="date" label="Дата">
            <secure role="beta" editable="true"/>
            <secure role="master" editable="true"/>
            <init with="today"/>
        </parameter>
        
        <field name="id" />
        
        <form name="zones" concept="mp-zone" is-set="true" what-label="зону">
            
            <secure role="terminal-technik">
                <where name="agent-type">megaport.techniks</where>
            </secure>
            
            <join name="sysuser" field="username"/>
            
            <field name="id"/>
            <field name="name" label="Зона"/>
            <field name="agent-type-name"/>
            
            <order-by name="agent-type" dir="asc"/>
            <order-by name="name" dir="asc"/>
            
            <form name="mp-zone-terminal">
                <field name="mp-terminal" aggregate="count" label="Кол-во терминалов"/>
            </form>
            
            <form name="zone-duties" concept="mp-agent-duty" page-size="1">
                
                <join name="sysuser" field="date"/>
                
                <order-by name="date" dir="desc"/>
                
                <form name="agent" concept="mp-agent">
                    <field name="name" label="Назначен"/>
                </form>
                
                <field name="ndoc"/>
                
            </form>
            
        </form>
        
        <form name="mp-agent">
            
            <join name="sysuser" field="username" property="loginname"/>
            
            <form name="detailed-zone" concept="mp-zone">
                
                <parameter name="zone-to-detail-id" modifiable="true" property="id"/>
                
                <field name="name" label="Зона"/>
                <field name="id"/>
                
                <form name="current-route" concept="mp-agent-duty" page-size="1">
                    
                    <join name="sysuser" field="date"/>
                    
                    <order-by name="ndoc" dir="desc"/>
                    
                    <field name="id"/>
                    <field name="ndoc"/>
                    
                    <form name="current-duty-task" concept="mp-agent-duty-task" is-set="true">
                        
                        <field name="id"/>
                        
                        <field name="task-type" label="Задача">
                            <sql-compute>
                                (select break_name from dbo.terminal_break tb where id = [current-duty-task].[terminal_break])
                            </sql-compute>
                        </field>
                        
                        <field name="is-served"/>
                        <field name="is-penalty-canceled" format="true-only"/>
                        
                        <field name="mp-terminal"/>
                        
                        <field name="resolution" label-="Результат">
                            <sql-compute>
                                case
                                    when servstatus=1 then 'OK'
                                    when penaltystatus=0 then 'Штраф'
                                    else 'Отмена'
                                end
                            </sql-compute>
                        </field>
                        
                        <field name="do-before" format="hh:mm"/>
                        
                        <form name="current-duty-task-terminal" concept="mp-terminal">
                            
                            <parameter name="current-duty-task-ok-parm"
                                type="int"
                                modifiable="true"
                                property="ok-pressed"
                                optional="true"
                            />
                            
                            <parameter name="current-duty-task-ok-user"
                                property="ok-user"
                                optional="true"
                                modifiable="true"
                            />
                            
                            <field name="address"/>
                            <field name="code"/>
                            <field name="last-check-ts" format="hh:mm:ss"/>
                            
                            <form name="current-duty-task-terminal-processing" concept="processing">
                                <field name="name" label="Система"/>
                            </form>
                            
                            <field name="error"/>
                            
                            <field name="terminalid" hidden="true"/>
                            
                        </form>
                        
                        <field name="agent-priority"/>
                        
                        <order-by name="is-served" dir="asc"/>
                        <order-by name="do-before" dir="asc"/>
                        
                    </form>
                    
                </form>
                
                <form name="mp-detailed-zone-terminal" concept="mp-zone-terminal" is-set="true">
                    
                    <form name="problem-terminal" concept="mp-terminal" constrain-parent="true">
                        
                        <where name="error"><not/></where>
                        
                        <field name="error"/>
                        <field name="code"/>
                        <field name="address"/>
                        <field name="lastactivitytime"/>
                        
                        <form name="problem-terminal-processing" concept="processing">
                            <field name="name" label="Система"/>
                        </form>
                    </form>
                    
                    <sort form="problem-terminal" field="address"/>
                    
                </form>
                
            </form>
            
        </form>
        
    </form></view-schema>
    
    <workflow>
        
        <step name="index" label-="">
            
            <display>
                
                <input field="date" form="sysuser"/>
                
                <grid form="zones">
                    
                    <option name="to-zone-details" label="...">
                        <command name="mp-terminal-service">zone-tasks</command>
                        <command name="zone-to-detail-id" xpath-compute="xi:datum[@name='id']" />
                    </option>
                    
                    <group>
                        <by form="zones" field="agent-type-name"/>
                    </group>
                    
                </grid>
                
            </display>
            
        </step>
        
        <step name="zone-tasks" hidden="true">
            
            <display>
                
                
                <region>
                    <print form="sysuser" field="date"/>
                    <input field="zone-to-detail-id" label="Зона">
                        <by form="zones" field="id"/>
                    </input>
                </region>
                
                <grid form="current-duty-task" refreshable="true" label="Задания маршрута" >
                    
                    <class field="agent-priority" form="current-duty-task"/>
                    
                    <option reuse="current-duty-task-ok-button"/>
                    
                    <columns>
                        <column field="task-type"/>
                        <column field="do-before"/>
                        <column label="Терминал">
                            <region class="hbox">
                                <print field="code" form="current-duty-task-terminal"/>
                                <print field="address" form="current-duty-task-terminal"/>
                                <print field="last-check-ts" form="current-duty-task-terminal"/>
                            </region>
                            <print field="error" form="current-duty-task-terminal" class="exception"/>
                        </column>
                    </columns>
                    
                    <group>
                        <by field="is-served" form="current-duty-task"/>
                    </group>
                    
                </grid>
                
            </display>
            
            <choise>
                <option reuse="to-index"/>
                <option reuse="to-faults"/>
            </choise>
            
        </step>
        
        <step name="zone-problems" hidden="true">
            
            <display>
                
                <print form="sysuser" field="date"/>
                <print form="detailed-zone" field="*"/>
                
                <grid form="mp-detailed-zone-terminal" label="Терминалы с ошибкой" refreshable="true">
                    <group>
                        <by field="name" form="problem-terminal-processing"/>
                    </group>
                </grid>
                
            </display>
            
            <choise>
                <option reuse="to-index"/>
                <option reuse="to-tasks"/>
            </choise>
            
        </step>
        
        <reusables>
            
            <option name="to-index" label="К таблице зон">
                <command name="mp-terminal-service">index</command>
            </option>
            <option name="to-tasks" label="К заданиям">
                <command name="mp-terminal-service">zone-tasks</command>
            </option>
            <option name="to-faults" label="К терминалам с ошибкой">
                <command name="mp-terminal-service">zone-problems</command>
            </option>
            
            <option name="current-duty-task-ok-button" label="OK">
                <command xpath-compute="
                    descendant-or-self :: xi:datum [@name='current-duty-task-ok-parm']
                "><increment/></command>
                <command xpath-compute="
                    descendant-or-self :: xi:datum [@name='current-duty-task-ok-user']
                ">  <value>
                        <xpath-compute>
                            ancestor::xi:data[@name='sysuser']/xi:datum[@name='id']
                        </xpath-compute>
                    </value>
                </command>
            </option>
            
        </reusables>
        
    </workflow>
    
</view-definition>