<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="mp-routing" label="Задания агентам" version="1.0">
    
    <access role="alpha"/>
    
    <view-schema><form name="sysuser">
        
        <parameter name="name"> <init with="username"/> </parameter>
        <parameter name="device-name"> <init with="device-name"/> </parameter>
        <parameter name="date" type="date" editable="true"> <init with="today"/> </parameter>
        
        <field name="id" />
        
        <form name="agent" concept="mp-agent"
            label="Агент" what-label="агента"
            expect-choise="true" choise-style="table"
        >
            <field name="id"/>
            <field name="name"/>
            
            <reduce form="agent-routes-aggregate" field="date"/>
            
            <form name="agent-routes-aggregate" concept="mp-agent-duty"
                no-preload="true"
            >
                <field name="date" aggregate="max" label="Последний маршрут"/>
                <where name="date">
                    <more-than>today()-5</more-than>
                </where>
            </form>
            
            <form name="route" concept="mp-agent-duty" is-set="true" page-size="5">
                
                <!--where name="date">
                    <more-than>today()-5</more-than>
                </where-->
                
                <order-by name="ndoc" dir="desc"/>
                
                <field name="xid"/>
                <field name="ndoc"/>
                <field name="date"/>
                
                <form name="route-point" concept="mp-agent-duty-task"
                    is-set="true"
                >
                    
                    <field name="xid"/>
                    
                    <field name="visited"/>
                    <field name="info"/>
                    
                    <sort form="route-point-terminal" field="error" dir="desc"/>
                    
                    <form name="route-point-terminal" concept="mp-terminal">
                        <field name="code"/>
                        <field name="address"/>
                        <field name="terminalid"/>
                        <field name="lastactivitytime" format="smalltime"/>
                        <field name="lastpaymenttime" format="smalltime"/>
                        <field name="error"/>
                    </form>
                    
                </form>
                
            </form>
            
        </form>
        
    </form></view-schema>
    
    <workflow>
        
        <step name="index" label-="">
            
            <!--reusables>
                
                <choise name="">
                    <option name="" label="">
                        <command name=""></command>
                    </option>
                </choise>
                
            </reusables-->
            
            <display>
                
                <input form="agent"/>
                <!--input field="date" form="sysuser"/-->
                <print field="name" form="agent" label="Агент"/>
                
                <region class="tabs">
                    <for-each form="route" label-field="date">
                        <print field="ndoc"/>
                        <grid form="route-point">
                            <!--group>
                                <by form="route-point-terminal" field="error"/>
                            </group-->
                        </grid>
                    </for-each>
                </region>
                
            </display>
            
        </step>
        
    </workflow>
    
</view-definition>