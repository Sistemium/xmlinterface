<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="sales-ordering" label="Предзаказы">
    <view-schema version="1.1" client-js-="true">
        <form name="sysuser">
            <parameter name="name">
                <init with="username"/>
            </parameter>
            <parameter name="device-name">
                <init with="device-name"/>
            </parameter>
            <parameter name="username">
                <init with="username"/>
            </parameter>
            
            <form name="cat-agent" label="Пользователь">
                <join name="sysuser" field="username"/>
                <field name="id" />
                <field name="name" />
                <form name="cat-salesman" label="Торговый представитель">
                    <field name="id" />
                    <field name="name" label="Торговый представитель"/>
                    
                    <form name="cat-buyer" expect-choise="true" choise-style="table" label="Покупатель">
                        <field name="id"/>
                        <field name="name"/>
                        <field name="address"/>
                        <field name="draftsCnt" type="int" label="Кол-во предзаказов"
                               sql-compute="(select nullif(count(*),0) from palm_ordorder
                                              where client_id=[cat-buyer].id and salesman_id=[cat-salesman].[salesman_id] and toDate>today() - 1)"/>
                        
                        <form name="cat-partner" no-preload="true">
                            <field name="name" label="Партнёр"/>
                        </form>
                        
                        <form name="sale-order" is-set="true">
                            <field name="id"/>
                            <field name="date"/>
                            <field name="ndoc"/>
                            <field name="comment"/>
                            <field name="status"/>
                            <field name="summ"/>
                            <field name="debtSumm"/>
                            <order-by name="ddate" dir="desc"/>
                            <order-by name="ndoc" dir="desc"/>
                        </form>

                        <form name="order-drafts" concept="cat">
                            <form name="order-draft" concept="pre-order" is-set="true" deletable="true">
                                <join name="cat-buyer"/>
                                <where name="date"><more-than>today() - 1</more-than></where>
                                <field name="xid"/>
                                <field name="date"/>
                                <field name="isBonus"/>
                                <field name="totalCost"/>
                                <field name="isWhite"/>
                                <field name="incassNeeded"/>
                            </form>
                        </form>
                        
                        <form name="order-editor" concept="pre-order" parent-sql-name="client">
                            <parameter name="xid" modifiable="true"/>
                            
                            <field name="id"/>
                            <field name="date"/>
                            <field name="isBonus"/>
                            <field name="totalCost" modifiable="true" xpath-compute="."/>
                            <field name="isWhite"/>
                            <field name="incassNeeded"/>
                            
                            <form name="oe-category" concept="category" label="Категория" is-set="true">
                                <field name="id"/>
                                <field name="name"/>
                                <form name="oe-article" concept="article" is-set="true" constrain-parent="true">
                                    <field name="id"/>
                                    <field name="name"/>
                                    <field name="rel"/>
                                    <form name="order-editor-goods" concept="pre-order-item" constrain-parent="true">
                                        <join name="order-editor"/>
                                        <field name="xid"/>
                                        <field name="volume"/>
                                        <field name="cost"/>
                                        <form name="oe-recent" concept="client-active-article">
                                            <field name="days-since-order" label="Прошлый заказ дней назад"/>
                                            <join name="cat-buyer"/>
                                            <join name="oe-article" role="article"/>
                                        </form>
                                    </form>
                                </form>
                            </form>
                            
                        </form>
                        
                        <form name="new-order" concept="pre-order" parent-sql-name="client" autosave="true">
                            <field name="id"/>
                            <field name="xid"/>
                            <field name="date" editable="true"/>
                            <field name="isBonus" editable="true"/>
                            <!--field name="totalCost" modifiable="true" 
                                   xpath-compute="sum(dyn:map(../descendant::xi:data[@name='new-order-item'][xi:datum[@name='volume'] &gt; 0]/xi:datum[@name='cost'],'dyn:evaluate(@xpath-compute)')
                                                     |following-sibling::xi:data[@name='no-category']/xi:data[@name='no-other-total']/xi:datum
                                                     )
                                                 "/-->
                            <field name="isWhite" editable="true"/>
                            <field name="incassNeeded" editable="true"/>
                                                        
                            <parameter name="build-new-order" type="int" modifiable="true"/>
                            <parameter name="days-back" type="int" editable-="true" label="Статистика за (дней)">
                                <init with="const">90</init>
                            </parameter>
                            
                            <join name="cat-salesman"/>
                            
                            <form name="no-category" concept="category" label="Категория" is-set="true">
                                <field name="id"/>
                                <field name="name"/>
                                <join name="cat-buyer"/>
                                <!--form name="no-other-total" concept="pre-order-item">
                                    <join name="new-order" role="pre-order"/>
                                    <field name="cost" aggregate="sum"/>
                                    <where name="article" type="int"> any (select id from sales.article a where not a.category=[no-category].id)</where>
                                </form-->
                                <order-by name="ord" dir="asc"/>
                                <form name="no-package" concept="package" role="order-package" no-preload="true">
                                    <field name="name" label="Упаковка"/>
                                </form>
                                <form name="no-available" concept="pre-order-item-available" is-set="true"
                                      constrain-parent="true" pipeline="clientData">
                                    <natural-key>
                                        <part form="cat-buyer" field="id"/>
                                        <part form="no-category" field="id"/>
                                        <part form="new-order" field="date"/>
                                    </natural-key>
                                    <sort form="no-article" field="name" />
                                    <join name="new-order" field="date"/>
                                    <join name="cat-buyer"/>
                                    <field name="price"/>
                                    <form name="no-article" concept="article" constrain-parent="true">
                                        <field name="id"/>
                                        <field name="factor" label="Кр."/>
                                        <field name="first-name" label="Подкатегория" />
                                        <field name="second-name"/>
                                        <field name="name" hidden="true"/>
                                        <field name="rel" hidden="true"/>
                                        <!--field sql-compute="null" name="volume" editable="true" label="Кол-во" type="int">
                                            <spin field="factor" form="no-article"/>
                                        </field-->
                                        <form name="no-recent" concept="client-active-article" constrain-parent-="true">
                                            <!--field name="count" label="Заказов шт."/-->
                                            <field name="days-since-order" label="Прош. зак."/>
                                            <!--field name="isFeatured" type="boolean" sql-compute="days_since &gt; 0"/-->
                                            <join name="cat-buyer"/>
                                            <!--join name="new-order" field="days-back"/-->
                                        </form>
                                        <form name="new-order-item" concept="pre-order-item" build-blank="true" parent-sql-name="goods" autosave="true">
                                            <join name="new-order" role="pre-order"/>
                                            <natural-key>
                                                <part root="id"/>
                                                <part form="no-article" field="id"/>
                                            </natural-key>
                                            <field name="xid"/>
                                            <field name="cost"
                                                   modifiable="true" label="Стоимость"
                                                   xpath-compute-="following-sibling::xi:datum[@name='volume']
                                                                 * parent::xi:data/parent::xi:data/xi:datum[@name='price']
                                                                 * parent::xi:data/xi:datum[@name='rel']
                                                                 "/>
                                            <field name="volume" editable="true" when-null-then-delete="true">
                                                <spin field="factor" form="no-article"/>
                                            </field>
                                        </form>
                                    </form>
                                </form>
                            </form>
                            
                        </form>
                        
                    </form>
                </form>
            </form>
        </form>
    </view-schema>
    <workflow>
        <step name="home">
            <display>
                <print form="cat-salesman" field="name"/>
                <input form="cat-buyer"/>
                <print form="cat-buyer" field="address"/>
                <grid form="order-draft" label="Предзаказы">
                    <option label="Просмотр">
                        <command name="xid" xpath-compute="xi:datum[@name='xid']"/>
                        <command name="sales-ordering">order-editor</command>
                    </option>
                </grid>
                <grid form="sale-order" label="Заказы"/>
            </display>
            <choise>
                <option label="К списку точек">
                    <command name="cat-buyer">unchoose</command>
                </option>
                <option label="Новый заказ ...">
                    <command name="build-new-order">1</command>
                    <command name="sales-ordering">new-order-editor</command>
                </option>
            </choise>
        </step>
        <step name="order-editor" label="Просмотр предзаказа" hidden="true">
            <display>
                <region name="twocolumn">
                    <print form="cat-buyer" field="name"/>
                    <print form="cat-buyer" field="address"/>
                    <print form="cat-partner" field="name"/>
                </region>
                <region name="twocolumn">
                    <print form="order-editor" field="date"/>
                    <print form="order-editor" field="isBonus"/>
                    <print form="order-editor" field="isWhite"/>
                    <print form="order-editor" field="incassNeeded"/>
                    <print form="order-editor" field="totalCost"/>
                </region>
                <grid form="oe-article">
                    <group>
                        <by form="oe-category" field="name"/>
                    </group>
                </grid>
            </display>
            <choise>
                <option label="К списку заказов">
                    <command name="order-drafts">refresh</command>
                    <command name="sales-ordering">home</command>
                </option>
                <option label="Новый заказ ...">
                    <command name="build-new-order">1</command>
                    <command name="sales-ordering">new-order-editor</command>
                </option>
            </choise>
        </step>
        <step name="new-order-editor" label="Создание предзаказа" hidden="true">
            <display>
                <region name="twocolumn">
                    <print form="cat-buyer" field="name"/>
                    <print form="cat-buyer" field="address"/>
                    <print form="cat-partner" field="name"/>
                    <input field="days-back"/>
                </region>
                <region name="twocolumn">
                    <input form="new-order" field="date"/>
                    <input form="new-order" field="isBonus"/>
                    <input form="new-order" field="isWhite"/>
                    <input form="new-order" field="incassNeeded"/>
                    <print form="new-order" field="totalCost"/>
                </region>
                <input field="article-searcher"/>
                <for-each form="no-category" label-field="name" collapsable="true">
                    <print form="no-package" field="name"/>
                    <grid form="no-available" accordeon="true">
                        <group>
                            <by form="no-article" field="first-name"/>
                        </group>
                        <class name="featured" form="no-recent" field="days-since-order"/>
                    </grid>
                </for-each>
            </display>
            <choise>
                <option label="К списку заказов">
                    <command name="sales-ordering">home</command>
                    <command name="order-drafts">refresh</command>
                </option>
                <option label="Просмотр заказа">
                    <command name="order-editor">refresh</command>
                    <command name="sales-ordering">order-editor</command>
                    <command field="xid" form="order-editor" xpath-compute="ancestor::xi:view/xi:view-data//xi:data[@name='new-order']/xi:datum[@name='xid'][1]"/>
                </option>
            </choise>
        </step>
    </workflow>
</view-definition>