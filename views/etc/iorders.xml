<?xml version="1.0"?>
<view-definition xmlns="http://unact.net/xml/xi" name="iorders" >
    
    <view-schema version="1.954" expect-megabytes="15" >
        
        <form name="sysuser" hidden="true">
            
            <parameter name="name"> <init with="username"/> </parameter>
            <parameter name="device-name"> <init with="device-name"/> </parameter>
            <parameter name="username"> <init with="username"/> </parameter>
            <parameter name="date" type="date"> <init with="today"/> </parameter>
            
            <form name="Person" concept="cat-agent" label="Сотрудник" set-label="Сотрудники" hidden="true">
                
                <join name="sysuser" field="username"/>
                
                <field name="id" />
                <field name="name" />
                
                <form name="cat-salesman" hidden="true">
                    
                    <field name="id" />
                    <field name="name" />
                    
                    <form name="logger" concept="sales-logger" hidden="true">
                        <parameter name="version"> <init with="view-schema-version"/> </parameter>
                    </form>
                    
                    <form name="Uncashment" concept="sales-uncashment" is-set="true" pipeline="download"
                          extendable="true" parent-sql-name="salesman"
                          label="Сданная выручка" set-label="Сданная выручка">
                        
                        <field name="id" />
                        <field name="datetime" modifiable="upload" />
                        <field name="totalSumm" modifiable="upload" />
                        <field name="totalSummWhite" modifiable="upload" />
                        
                        <field name="xid" />
                        
                        <where name="datetime">
                            <more-than>today() - 10</more-than>
                        </where>
                        
                    </form>
                    
                    <form name="PricelistSet" concept="pricelist-set" is-set="true" pipeline="download"
                          label="Ценовая категория" set-label="Ценовые категории">
                        <field name="id"/>
                        <field name="name"/>
                    </form>
                    
                    <form name="Pricelist" concept="pricelist" is-set="true" pipeline="download"
                          label="Прайс-лист" set-label="Прайс-листы">
                        <field name="id"/>
                        <field name="name"/>
                    </form>
                    
                    <form name="ShopDepartment" concept="shop-department" is-set="true" pipeline="download"
                          label="Отдел магазина" set-label="Отделы магазина">
                        <field name="id"/>
                        <field name="name"/>
                        <field name="ord"/>
                    </form>
                    
                    <form name="Category" concept="category" expect-choise="true"
                          label="Категория товаров" set-label="Категории товаров">
                        
                        <field name="id"/>
                        <field name="name"/>
                        <field name="ord"/>
                        
                        <field name="shop-department" alias="shopDepartment"/>
                        
                        <order-by name="ord" dir="asc"/>
                        
                        <where name="shop-department">
                            <more-than>0</more-than>
                        </where>
                        
                        <form name="Product" concept="article" is-set="true" pipeline="download"
                              label="Товар" set-label="Товары">
                            <field name="id"/>
                            <field name="name"/>
                            <field name="extraLabel" />
                            <field name="first-name" alias="firstName" sql-compute="left(product.name, locate(product.name,' ') - 1)" >
                                <!--secure role="ad-user" sql-compute="'Роллтон'"/-->
                            </field>
                            <field name="factor" />
                            <field name="rel" />
                            <field name="cost"/>
                            <field name="lastName" type="string"
                                   label="Производитель"
                            ><sql-compute>
                                isnull ((
                                    select nullif(spv.name,'')
                                        from sp_values spv
                                        join valid_sp_sets vsp
                                        on vsp.spv_id=spv.id and vsp.sp_tp =
                                            if [Product].category=1352 then 26078 else 1034 endif and goods = [Product].id)
                                    , '(не указан)'
                                )
                            </sql-compute></field>

                            <field name="package" />
                            
                            <where name="isRemoved">0</where>
                            
                            <join name="cat-salesman"/>
                            
                        </form>
                        
                        <form name="Price" concept="sales-price" pipeline="download" is-set="true"
                              label="Цена прайс-листа" set-label="Цены прайс-листа">
                            
                            <field name="pricelist-set" alias="pricelistSet" key="true"/>
                            <field name="pricelist" key="true"/>
                            <field name="article" alias="product" key="true"/>
                            
                            <field name="price"/>
                            
                            <!--parameter name="date" type="date">
                                <init with="today"/>
                            </parameter-->
                            
                            <join name="cat-salesman"/>
                        </form>
                        
                    </form>
                    
                    <form name="BonusProgram" concept="bonus-program" is-set="true" pipeline="download"
                          label="Бонусная программа" set-label="Бонусные программы">
                        <field name="id"/>
                        
                        <field name="name" />
                        <field name="goal"/>
                        <field name="gain"/>
                        <field name="dateStart"  hidden="true"/>
                        <field name="dateEnd"  hidden="true"/>
                        <field name="tag"  hidden="true"/>
                        <field name="tagColor" hidden="true"/>
                        <field name="isFocused"  hidden="true"/>
                        <field name="isFirstScreen"  hidden="true"/>
                        <field name="isNonHidable"  hidden="true"/>
                        <field name="isPopAtStart"  hidden="true"/>
                        <field name="isCustomerTargeted"  hidden="true"/>
                        
                        <where name="isActive">1</where>
                        
                        <form name="BonusProgramProduct" concept="bonus-program-article" is-set="true"
                              label="Товар бонусной программы" set-label="Товары бонусной программы">
                            <field name="article" alias="product"/>
                            <add-labeled-fields/>
                        </form>
                        
                    </form>
                    
                    <form name="Warehouse" concept="sales-warehouse" is-set="true" pipeline="download" 
                          label="Склад" set-label="Склады">
                        <field name="id" />
                        <field name="name" />
                        
                        <form name="Stock" concept="sales-stock" is-set="true" constrain-parent="true" pipeline="download"
                              label="Остаток" set-label="Остатки">
                            <field name="article" alias="product" key="true"/>
                            <field name="level" alias="stockLevel"/>
                        </form>
                        
                    </form>
                    
                    <form name="Partner" concept="cat-partner" is-set="true"
                          label="Партнер" set-label="Партнеры" pipeline="download">
                        
                        <field name="id"/>
                        
                        <field name="isBlockedPlong" type="boolean"
                               sql-compute="(select block from dbo.ask_ordclient(@partner = Partner.id))"
                               label="Заблокирован по просрочке"/>
                        
                        <add-labeled-fields/>
                        
                        <form name="PartnerPriceList" concept="partner-pricelist" is-set="true"
                              label="Прайслист партнера" set-label="Прайслисты партнера">
                            <!--field name="id"/-->
                            <field name="pricelist-set" alias="pricelistSet" key="true"/>
                            <field name="pricelist" />
                            <field name="discount"/>
                        </form>
                        
                        <form name="PartnerPrice" concept="partner-price" is-set="true"
                              label="Цена для партнера" set-label="Цены для партнера">
                            <field name="article" alias="product" key="true"/>
                            <field name="price"/>
                        </form>
                        
                        <form name="Debt" concept="pos-debt" is-set="true"
                              label="Задолженность" set-label="Задолженность">
                            <field name="id"/>
                            <field name="date" alias="ddate"/>
                            <field name="info" alias="ndoc"/>
                            <field name="summ" alias="fullSumm"/>
                            <field name="isWhite" />
                            <field name="csum" alias="remSumm" aggregable="sum"/>
                            <field name="dateUntil" />
                            <field name="isOverdue" />
                            <field name="debt-origin" alias="partner"/>
                            
                            <join name="cat-partner" role="cat-partner"/>
                            <join name="cat-salesman"/>
                            
                            <order-by name="own" dir="desc"/>                                
                            <order-by name="date" dir="desc"/>
                        </form>
                        
                        <form name="Customer" concept="cat-buyer" is-set="true" constrain-parent="true"
                              label="Клиент" set-label="Клиенты">
                            
                            <field name="id"/>
                            <field name="sales-warehouse" alias="warehouse"/>
                            
                            <field name="isBlockedPlong" type="boolean"
                                   sql-compute="(select block from dbo.ask_ordclient(@partner = Partner.id))"
                                   label="Заблокирован по просрочке"/>
                            
                            <field name="address" title="true"/>
                            
                            <add-labeled-fields/>
                            
                            <form name="CustomerBonusProgram" concept="bonus-program-client" is-set="true"
                                  label="Программа клиента" set-label="Программы клиентов">
                                
                                <field name="bonus-program" alias="bonusProgram"/>
                                
                            </form>
                            
                            <form name="EncashmentRequest" concept="sales-encashment-request"
                                  is-set="true" extendable="true"
                                  parent-sql-name="client" deletable="new-only"
                                  label="Заявка на инкассацию" set-label="Заявки на инкассацию"
                                  mainMenu="true"
                            >
                                
                                <field name="id" type="string"/>
                                <field name="xid"/>
                                
                                <field name="date" editable="true"/>
                                <field name="comment" editable="true"/>
                                
                                <field name="status" />
                                
                                <where name="date">
                                    <more-than>today() - 2</more-than>
                                </where>
                                
                            </form>
                            
                            <form name="SaleOrder" concept="pre-order"
                                  is-set="true" extendable="true"
                                  parent-sql-name="client" deletable="new-only"
                                  label="Заказ" set-label="Заказы"
                            >
                                
                                <field name="id" type="string"/>
                                <field name="xid"/>
                                <field name="deviceCts" editable="new-only"/>
                                
                                <field name="processing" editable="status" init="upload"/>
                                
                                <field name="isBonus" editable="true"/>
                                
                                <field name="incassNeeded" editable="true"/>
                                <field name="isWhite" editable="true"/>
                                <field name="date" editable="true"/>
                                <field name="totalCost" modifiable="true"/>
                                <field name="comment" editable="true"/>
                                
                                <join name="cat-salesman"/>
                                
                                <where name="date"><more-than>today() - 1</more-than></where>
                                
                                <form name="SaleOrderPosition" concept="pre-order-item" is-set="true" extendable="true"
                                      parent-sql-name="pre_order" deletable="new-only"
                                      label="Позиция заказа" set-label="Позиции заказа">
                                    <field name="volume" editable="true"/>
                                    <field name="package" editable="true"/>
                                    <field name="cost"  editable="compute"/>
                                    <field name="xid"/>
                                    <field name="article" alias="product" no-inwards="true" editable="new-only" key="true"/>
                                </form>
                                
                            </form>
                            
                            <form name="Encashment" concept="sales-encashment" is-set="true"
                                  extendable="true" deletable="new-only" parent-sql-name="client"
                                  label="Инкассация" set-label="Инкассации">
                                
                                <field name="id" type="string"/>
                                <field name="xid"/>
                                
                                <field name="isWhite" editable="true"/>
                                
                                <field name="datetime" editable="true"/>
                                <field name="summ" editable="true"/>
                                <field name="pos-debt" alias="debt" editable="true"/>
                                
                                <field name="sales-uncashment" alias="uncashment" modifiable="true" optional="true" />
                                
                                <join name="cat-salesman"/>
                                
                            </form>
                            
                        </form>
                        
                    </form>
                    
                    <form name="CustomerBonusProgramMessage" concept="bonus-program-client-message"
                        is-set="true" mainMenu="true"
                        label="Сообщение от программы" set-label="Сообщения от программ"
                        pipeline="download"
                    >
                        
                        <field name="cat-buyer" alias="customer" title="true"/>
                        <field name="bonus-program" alias="bonusProgram" />
                        
                        <field name="msg" title="true"/>
                        
                    </form>
                    
                    <form name="Shipment" concept="sales-shipment"
                          is-set="true" 
                          label="Отгрузка" set-label="Отгрузки"
                          pipeline="download" page-size="150"
                    >
                        
                        <field name="id" />
                        
                        <add-labeled-fields/>
                        
                        <field name="cat-buyer" alias="customer"/>
                        
                        <field name="lastActive" sql-compute="null" hidden="true" type="int"/>
                        
                        <!--where name="date"><more-than>today() - 60</more-than></where-->
                        
                        <form name="ShipmentPosition" concept="sales-shipment-position"
                              is-set="true" 
                              label="Позиция отгрузки" set-label="Позиции отгрузки"
                        >
                            <field name="xid" key="true"/>
                            
                            <field name="article" alias="product" no-inwards="true" key-="true"/>
                            
                            <add-labeled-fields/>
                            
                        </form>
                    </form>
                    
                    <form name="Route" concept="salesman-route" is-set="true" pipeline="download" 
                          label="Маршрут" set-label="Маршруты">
                        <field name="id" />
                        <field name="name" />
                        <field name="ord"/>
                        
                        <form name="RoutePoint" concept="salesman-route-point" is-set="true" pipeline-="download"
                              label="Точка маршрута" set-label-="Точки маршрута">
                            <field name="cat-buyer" alias="customer" key="true"/>
                            <field name="ord"/>
                            <join name="cat-salesman"/>
                        </form>
                        
                    </form>
                    
                    <form name="Geolocation" concept="geoposition" is-set="true" pipeline="-" extendable="true">
                        
                        <field name="id" />
                        <field name="latitude" editable="true" />
                        <field name="longitude" editable="true" />
                        <field name="accuracy" editable="true" />
                        <field name="speed" editable="true" />
                        <field name="deviceCts" editable="new-only" />
                        <field name="errorCode" editable="true" />
                        <field name="xid" />
                        
                        <where name="id">0</where>
                        
                    </form>
                    
                </form>
            </form>
            
        </form>
    </view-schema>
    
    <workflow>
        <step name="Offer">
            
            <input form="Customer">
                <input form="Category">
                    
                    <for-each form="PartnerPriceList">
                        <for-each form="Price">
                            <print form="Price" field="price"/>
                            <input form="Product">
                                
                                <print form="Product" field="first-name"/>
                                <print form="Product" field="lastName"/>
                                <print form="Product" field="name"/>
                                <print form="Product" field="rel"/>
                                <print form="Product" field="factor"/>
                                <print form="Product" field="package"/>
                                <print form="Product" field="extraLabel"/>
                                
                                <print form="BonusProgram" field="tag" alias="BonusProgram_tag"/>
                                <print form="BonusProgram" field="tagColor" alias="BonusProgram_tagColor"/>
                                <print form="BonusProgram" field="isFirstScreen" />
                                <print form="BonusProgram" field="isNonHidable" />
                                
                                <for-each form="Stock">
                                    <print form="Stock" field="level" />
                                </for-each>
                                
                                <print form="SaleOrderPosition" field="cost"/>
                                <print form="Shipment" field="lastActive"/>
                                
                            </input>
                        </for-each>
                    </for-each>
                    
                </input>
            </input>
            <sql>
                select
                   c.id as customer,
                   g.category,
                   coalesce(
                        (select price from PartnerPrice where partner = c.partner and product = g.id),
                        (select p.price from PartnerPriceList ppl 
                                join Price p on p.pricelistSet = ppl.pricelistSet and p.priceList = ppl.priceList and g.id = p.product
                                where ppl.partner = c.partner)
                   ) as price,
                   g.id as Product,
                   g.firstName, g.lastName,
                   g.name,
                   g.rel,
                   g.factor,
                   g.package,
                   g.extraLabel,
                   (select group_concat(bp.tag)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     )
                   ) as BonusProgram_tag,
                   (select group_concat(bp.tagColor, ' ')
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                    where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                    )
                   ) as BonusProgram_tagColor,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isFirstScreen = 1
                   ) as isFirstScreen,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isNonHidable = 1
                   ) as isNonHidable,
                   s.stockLevel,
                   null as cost,
                   round(julianday() - (select julianday(replace(max(s.date), '/', '-')) from Shipment s join ShipmentPosition sp on sp.shipment = s.id
                     where sp.product = g.id and s.customer = c.id
                    ),0) as lastActive
                from Customer c
                   join Stock s on s.warehouse = c.warehouse and s.stockLevel &gt; 0
                   join Product g on s.product = g.id 
                where price &gt; 0
            </sql>
            
        </step>

        <step name="OfferByBonusProgram">
            
            <input form="Customer">
                <input form="Category">
                    
                    <for-each form="PartnerPriceList">
                        <for-each form="Price">
                            <print form="Price" field="price"/>
                            <input form="Product">
                                
                                <print form="Product" field="first-name"/>
                                <print form="Product" field="lastName"/>
                                <print form="Product" field="name"/>
                                <print form="Product" field="rel"/>
                                <print form="Product" field="factor"/>
                                <print form="Product" field="package"/>
                                <print form="Product" field="extraLabel"/>
                                
                                <print form="BonusProgram" field="tag" alias="BonusProgram_tag"/>
                                <print form="BonusProgram" field="tagColor" alias="BonusProgram_tagColor"/>
                                <print form="BonusProgram" field="isFirstScreen" />
                                <print form="BonusProgram" field="isNonHidable" />
                                
                                <for-each form="Stock">
                                    <print form="Stock" field="level" />
                                </for-each>
                                
                                <print form="SaleOrderPosition" field="cost"/>
                                <print form="Shipment" field="lastActive"/>
                                <print form="BonusProgram" field="id" alias="bonusProgram"/>
                                
                            </input>
                        </for-each>
                    </for-each>
                    
                </input>
            </input>
            <sql>
                select
                   c.id as customer,
                   g.category,
                   coalesce((select price from PartnerPrice where partner = c.partner and product = g.id),p.price) as price,
                   g.id as Product,
                   g.firstName, g.lastName,
                   g.name,
                   g.rel,
                   g.factor,
                   g.package,
                   g.extraLabel,
                   (select group_concat(bp.tag)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     )
                   ) as BonusProgram_tag,
                   (select group_concat(bp.tagColor, ' ')
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                    where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                    )
                   ) as BonusProgram_tagColor,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isFirstScreen = 1
                   ) as isFirstScreen,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isNonHidable = 1
                   ) as isNonHidable,
                   s.stockLevel,
                   null as cost,
                   round(julianday() - (select julianday(replace(max(s.date), '/', '-')) from Shipment s join ShipmentPosition sp on sp.shipment = s.id
                     where sp.product = g.id and s.customer = c.id
                    ),0) as lastActive,
                    bpp.bonusProgram as bonusProgram
                from Customer c
                   join PartnerPriceList ppl on ppl.partner = c.partner
                   join Price p on p.pricelistSet = ppl.pricelistSet and p.priceList = ppl.priceList
                   join Product g on g.id = p.product
                   join Stock s on s.product = g.id and s.warehouse = c.warehouse and s.stockLevel &gt; 0
                   join BonusProgramProduct bpp on bpp.product = g.id
            </sql>
            
        </step>

        <step name="OfferCategory">
            
            <input form="Customer">
                <input form="Category">
                    <print form="Category" field="name"/>
                    <!--print form="Category" field="ord"/-->
                    <print form="SaleOrder" field="totalCost"/>
                    <print form="Category" field="shop-department"/>
                    <print form="ShopDepartment" field="name" alias="ShopDepartment_name"/>
                    <print form="ShopDepartment" field="ord" alias="ShopDepartment_ord"/>
                    <print form="Shipment" field="lastActive"/>
                </input>
            </input>
            
            <sql>
                select c.*, sd.name as shopDepartment_name, sd.ord as shopDepartment_ord,
                       round(julianday() - (
                                select julianday(replace(max(s.date), '/', '-'))
                                  from Shipment s
                                  join ShipmentPosition sp on sp.shipment = s.id
                                  join product g on sp.product = g.id
                                  /*join stock on g.id = stock.product and stock.warehouse = c.warehouse and stocklevel &gt; 0*/
                                 where g.category = c.category and s.customer = c.customer
                       ),0) as lastActive
                  from (
                      select cu.id as customer, c.id category, c.name, c.ord,
                             null as totalCost, c.shopDepartment, cu.warehouse
                        from Customer cu, Category c
                  ) c join ShopDepartment sd on sd.id = c.shopDepartment
            </sql>
            
        </step>
        
        <step name="Cash" set-label="Выручка">
            
            <input form="Customer">
                <print form="Customer" field="name" alias="Customer_name"/>
            </input>
            
            <print form="Encashment" field="summ"/>
            <print form="Encashment" field="isWhite"/>
            <print form="Encashment" field="datetime"/>
            
            <sql>
                select e.*, c.name as Customer_name
                  from Encashment e join Customer c on c.id = e.customer
                 where e.uncashment is null
            </sql>
            
        </step>
        
    </workflow>
    
</view-definition>