<?xml version="1.0" encoding="utf-8"?>

<view-definition xmlns="http://unact.net/xml/xi" name="iorders">
    <view-schema version="1.986" expect-megabytes="15">
        <form name="demo" hidden="true">
            
            <field name="id"/>
            
            <parameter name="name">
                <init with="username"/>
            </parameter>
        
            <parameter name="device-name">
                <init with="device-name"/>
            </parameter>
        
            <parameter name="username">
                <init with="username"/>
            </parameter>
        
            <parameter name="date" type="date">
                <init with="today"/>
            </parameter>
            
            <form name="Uncashment" is-set="true" pipeline="download" extendable="true" label="Сданная выручка" set-label="Сданная выручка">
                <field name="id"/>
                <field name="datetime" modifiable="upload"/>
                <field name="totalSumm" modifiable="upload"/>
                <field name="totalSummWhite" modifiable="upload"/>
                <field name="xid"/>
                
                <where name="datetime">
                    <more-than>today() - 10</more-than>
                </where>
            </form>
        
            <form name="PricelistSet" is-set="true" pipeline="download" label="Ценовая категория" set-label="Ценовые категории">
                <field name="id"/>
                <field name="name"/>
            </form>
        
            <form name="Pricelist" is-set="true" pipeline="download" label="Прайс-лист" set-label="Прайс-листы">
                <field name="id"/>
                <field name="name"/>
            </form>
        
            <form name="ShopDepartment" is-set="true" pipeline="download" label="Отдел магазина" set-label="Отделы магазина">
                <field name="id"/>
                <field name="name"/>
                <field name="ord"/>
            </form>
        
            <form name="GapReason" is-set="true" pipeline="download" label="Причина непосещения" set-label="Причины непосещения">
                <field name="id"/>
                <field name="name"/>
            </form>
        
            <form name="Category" expect-choise="true" label="Категория товаров" set-label="Категории товаров">
                <field name="id"/>
                <field name="name"/>
                <field name="ord"/>
                <field name="shopDepartment"/>
                
                <order-by name="ord" dir="asc"/>
                
                <form name="Product" is-set="true" pipeline="download" label="Товар" set-label="Товары">
                    <field name="id"/>
                    <field name="name"/>
                    <field name="extraLabel"/>
                    <field name="firstName"/>
                    <field name="rel"/>
                    <field name="cost"/>
                    <field name="lastName" type="string" label="Производитель"/>
                    <field name="package" type="int"/>
                </form>
            
                <form name="Price" pipeline="download" is-set="true" label="Цена прайс-листа" set-label="Цены прайс-листа">
                    <field name="pricelistSet" key="true"/>
                    <field name="pricelist" key="true"/>
                    <field name="product" key="true"/>
                    <field name="price"/>
                </form>
            </form>
        
            <form name="BonusProgram" is-set="true" pipeline="download" label="Бонусная программа" set-label="Бонусные программы">
                <field name="id"/>
                <field name="name"/>
                <field name="goal"/>
                <field name="gain"/>
                <field name="dateStart" hidden="true"/>
                <field name="dateEnd" hidden="true"/>
                <field name="tag" hidden="true"/>
                <field name="tagColor" hidden="true"/>
                <field name="isFocused" hidden="true"/>
                <field name="isFirstScreen" hidden="true"/>
                <field name="isNonHidable" hidden="true"/>
                <field name="isPopAtStart" hidden="true"/>
                <field name="isCustomerTargeted" hidden="true"/>
                
                <form name="BonusProgramProduct" is-set="true" label="Товар бонусной программы" set-label="Товары бонусной программы">
                    <field name="product" key="true"/>
                    
                    <add-labeled-fields/>
                </form>
            </form>
        
            <form name="Warehouse" is-set="true" pipeline="download" label="Склад" set-label="Склады">
                <field name="id"/>
                <field name="name"/>
                
                <form name="Stock" is-set="true" constrain-parent="true" pipeline="download" label="Остаток" set-label="Остатки">
                    <field name="product" key="true"/>
                    <field name="stockLevel"/>
                    <field name="factor"/>
                </form>
            </form>
        
            <form name="Partner" is-set="true" label="Партнер" set-label="Партнеры" pipeline="download">
                <field name="id"/>
                <field name="isBlockedPlong" type="boolean" label="Заблокирован по просрочке"/>
                
                <add-labeled-fields/>
                
                <form name="PartnerPriceList" is-set="true" label="Прайслист партнера" set-label="Прайслисты партнера">
                    <field name="pricelistSet" key="true"/>
                    <field name="pricelist"/>
                    <field name="discount"/>
                </form>
            
                <form name="PartnerPrice" is-set="true" label="Цена для партнера" set-label="Цены для партнера">
                    <field name="product" key="true"/>
                    <field name="price"/>
                </form>
            
                <form name="Debt" is-set="true" label="Задолженность" set-label="Задолженность">
                    <field name="id"/>
                    <field name="ddate"/>
                    <field name="ndoc"/>
                    <field name="fullSumm"/>
                    <field name="isWhite"/>
                    <field name="remSumm" aggregable="sum"/>
                    <field name="dateUntil"/>
                    <field name="isOverdue"/>
                    <field name="partner"/>
                </form>
            
                <form name="Customer" is-set="true" constrain-parent="true" label="Клиент" set-label="Клиенты">
                    <field name="id"/>
                    <field name="warehouse"/>
                    <field name="isBlockedPlong" type="boolean" label="Заблокирован по просрочке"/>
                    <field name="address" title="true"/>
                    
                    <add-labeled-fields/>
                    
                    <form name="CustomerBonusProgram" is-set="true" label="Программа клиента" set-label="Программы клиентов">
                        <field name="bonusProgram"/>
                    </form>
                
                    <form name="EncashmentRequest" is-set="true" extendable="true" parent-sql-name="customer" deletable="new-only" label="Заявка на инкассацию" set-label="Заявки на инкассацию" mainMenu="true">
                        <field name="id" type="string"/>
                        <field name="xid"/>
                        <field name="date" editable="true"/>
                        <field name="comment" editable="true"/>
                        <field name="status"/>
                        
                        <where name="date">
                            <more-than>today() - 2</more-than>
                        </where>
                    </form>
                
                    <form name="MerchVisit" is-set="true" extendable="true" parent-sql-name="customer" deletable="new-only" label="Прочая активность" set-label="Прочие активности">
                        <field name="id" type="string"/>
                        <field name="xid"/>
                        <field name="deviceCts" modifiable="true"/>
                        <field name="gapReason" modifiable="true"/>
                        
                        <where name="deviceCts">
                            <more-than>today() - 1</more-than>
                        </where>
                    </form>
                
                    <form name="SaleOrder" is-set="true" extendable="true" parent-sql-name="customer" deletable="new-only" label="Заказ" set-label="Заказы">
                        <field name="id" type="string"/>
                        <field name="xid"/>
                        <field name="deviceCts" editable="new-only"/>
                        <field name="processing" editable="status" init="upload"/>
                        <field name="isBonus" editable="true"/>
                        <field name="incassNeeded" editable="true"/>
                        <field name="isWhite" editable="true"/>
                        <field name="date" editable="true"/>
                        <field name="totalCost" modifiable="true"/>
                        <field name="totalSelfCost" type="decimal" label="Себестоимость"/>
                        <field name="comment" editable="true"/>
                        
                        <where name="date">
                            <more-than>today() - 1</more-than>
                        </where>
                        
                        <form name="SaleOrderPosition" is-set="true" extendable="true" parent-sql-name="saleOrder" deletable="new-only" label="Позиция заказа" set-label="Позиции заказа">
                            <field name="volume" editable="true"/>
                            <field name="package" editable="true" type="int"/>
                            <field name="cost" editable="compute"/>
                            <field name="selfCost" type="decimal"/>
                            <field name="xid"/>
                            <field name="product" no-inwards="true" editable="new-only" key="true"/>
                        </form>
                    </form>
                
                    <form name="Encashment" is-set="true" extendable="true" deletable="new-only" parent-sql-name="customer" label="Инкассация" set-label="Инкассации">
                        <field name="id" type="string"/>
                        <field name="xid"/>
                        <field name="isWhite" editable="true"/>
                        <field name="datetime" editable="true"/>
                        <field name="summ" editable="true"/>
                        <field name="debt" editable="true"/>
                        <field name="uncashment" modifiable="true" optional="true"/>
                    </form>
                </form>
            </form>
        
            <form name="CustomerBonusProgramMessage" is-set="true" mainMenu="true" label="Сообщение от программы" set-label="Сообщения от программ" pipeline="download">
                <field name="customer" title="true"/>
                <field name="bonusProgram"/>
                <field name="msg" title="true"/>
            </form>
        
            <form name="Shipment" is-set="true" label="Отгрузка" set-label="Отгрузки" pipeline="download" page-size="150">
                <field name="id"/>
                
                <add-labeled-fields/>
                
                <field name="customer"/>
                <field name="lastActive" hidden="true" type="int"/>
                
                <form name="ShipmentPosition" is-set="true" label="Позиция отгрузки" set-label="Позиции отгрузки">
                    <field name="xid" key="true"/>
                    <field name="subid" key="true"/>
                    <field name="product" no-inwards="true" key-="true"/>
                    
                    <add-labeled-fields/>
                </form>
            </form>
        
            <form name="Route" is-set="true" pipeline="download" label="Маршрут" set-label="Маршруты">
                <field name="id"/>
                <field name="name"/>
                <field name="ord"/>
                
                <form name="RoutePoint" is-set="true" pipeline-="download" label="Точка маршрута" set-label-="Точки маршрута">
                    <field name="customer" key="true"/>
                    <field name="ord"/>
                </form>
            </form>
        
            <form name="Geolocation" is-set="true" pipeline="-" extendable="true">
                <field name="id"/>
                <field name="latitude" editable="true"/>
                <field name="longitude" editable="true"/>
                <field name="accuracy" editable="true"/>
                <field name="speed" editable="true"/>
                <field name="deviceCts" editable="new-only"/>
                <field name="errorCode" editable="true"/>
                <field name="xid"/>
                
                <where name="id">0</where>
            </form>
        
            <form name="Eventlog" is-set="true" pipeline="-" extendable="true">
                <field name="module" editable="true"/>
                <field name="action" editable="true"/>
                <field name="data" editable="true"/>
                <field name="deviceCts" editable="new-only"/>
                <field name="xid"/>
            </form>
        </form>
    </view-schema>
    
    <workflow>
        <step name="Offer">
            <input form="Customer">
                <input form="Category">
                    <for-each form="PartnerPriceList">
                        <for-each form="Price">
                            <print form="Price" field="price"/>
                            
                            <input form="Product">
                                <print form="Product" field="first-name"/>
                                <print form="Product" field="lastName"/>
                                <print form="Product" field="name"/>
                                <print form="Product" field="rel"/>
                                <print form="Stock" field="factor"/>
                                <print form="Product" field="package"/>
                                <print form="Product" field="extraLabel"/>
                                <print form="Product" field="cost" alias="selfCost"/>
                                <print form="BonusProgram" field="tag" alias="BonusProgram_tag"/>
                                <print form="BonusProgram" field="tagColor" alias="BonusProgram_tagColor"/>
                                <print form="BonusProgram" field="isFirstScreen"/>
                                <print form="BonusProgram" field="isNonHidable"/>
                                
                                <for-each form="Stock">
                                    <print form="Stock" field="level"/>
                                </for-each>
                                
                                <print form="SaleOrderPosition" field="cost"/>
                                <print form="Shipment" field="lastActive"/>
                            </input>
                        </for-each>
                    </for-each>
                </input>
            </input>
            
            <sql>
                select
                   c.id as customer,
                   g.category,
                   coalesce(
                        (select price from PartnerPrice where partner = c.partner and product = g.id),
                        (select p.price from PartnerPriceList ppl 
                                join Price p on p.pricelistSet = ppl.pricelistSet and p.priceList = ppl.priceList and g.id = p.product
                                where ppl.partner = c.partner)
                   ) as price,
                   g.id as Product,
                   g.firstName, g.lastName,
                   g.name,
                   g.rel,
                   s.factor,
                   g.package,
                   g.extraLabel,
                   g.cost as selfCost,
                   (select group_concat(bp.tag)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     )
                   ) as BonusProgram_tag,
                   (select group_concat(bp.tagColor, ' ')
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                    where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                    )
                   ) as BonusProgram_tagColor,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isFirstScreen = 1
                   ) as isFirstScreen,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isNonHidable = 1
                   ) as isNonHidable,
                   s.stockLevel,
                   null as cost,
                   round(julianday() - (select julianday(replace(max(s.date), '/', '-')) from Shipment s join ShipmentPosition sp on sp.shipment = s.id
                     where sp.product = g.id and s.customer = c.id
                    ),0) as lastActive
                from Customer c
                   join Stock s on s.warehouse = c.warehouse and s.stockLevel &gt; 0
                   join Product g on s.product = g.id 
                where price &gt; 0
            </sql>
        </step>
    
        <step name="OfferByBonusProgram">
            <input form="Customer">
                <input form="Category">
                    <for-each form="PartnerPriceList">
                        <for-each form="Price">
                            <print form="Price" field="price"/>
                            
                            <input form="Product">
                                <print form="Product" field="first-name"/>
                                <print form="Product" field="lastName"/>
                                <print form="Product" field="name"/>
                                <print form="Product" field="rel"/>
                                <print form="Stock" field="factor"/>
                                <print form="Product" field="package"/>
                                <print form="Product" field="extraLabel"/>
                                <print form="Product" field="cost" alias="selfCost"/>
                                <print form="BonusProgram" field="tag" alias="BonusProgram_tag"/>
                                <print form="BonusProgram" field="tagColor" alias="BonusProgram_tagColor"/>
                                <print form="BonusProgram" field="isFirstScreen"/>
                                <print form="BonusProgram" field="isNonHidable"/>
                                
                                <for-each form="Stock">
                                    <print form="Stock" field="level"/>
                                </for-each>
                                
                                <print form="SaleOrderPosition" field="cost"/>
                                <print form="Shipment" field="lastActive"/>
                                <print form="BonusProgram" field="id" alias="bonusProgram"/>
                            </input>
                        </for-each>
                    </for-each>
                </input>
            </input>
            
            <sql>
                select
                   c.id as customer,
                   g.category,
                   coalesce((select price from PartnerPrice where partner = c.partner and product = g.id),p.price) as price,
                   g.id as Product,
                   g.firstName, g.lastName,
                   g.name,
                   g.rel,
                   s.factor,
                   g.package,
                   g.extraLabel,
                   g.cost as selfCost,
                   (select group_concat(bp.tag)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     )
                   ) as BonusProgram_tag,
                   (select group_concat(bp.tagColor, ' ')
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                    where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                    )
                   ) as BonusProgram_tagColor,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isFirstScreen = 1
                   ) as isFirstScreen,
                   (select max(1)
                      from BonusProgramProduct bpp join BonusProgram bp on bp.id = bpp.bonusProgram
                     where product = g.id and (
                        bp.isCustomerTargeted is null or exists (
                            select * from CustomerBonusProgram where customer = c.id and bonusprogram = bp.id
                        )
                     ) and bp.isNonHidable = 1
                   ) as isNonHidable,
                   s.stockLevel,
                   null as cost,
                   round(julianday() - (select julianday(replace(max(s.date), '/', '-')) from Shipment s join ShipmentPosition sp on sp.shipment = s.id
                     where sp.product = g.id and s.customer = c.id
                    ),0) as lastActive,
                    bpp.bonusProgram as bonusProgram
                from Customer c
                   join PartnerPriceList ppl on ppl.partner = c.partner
                   join Price p on p.pricelistSet = ppl.pricelistSet and p.priceList = ppl.priceList
                   join Product g on g.id = p.product
                   join Stock s on s.product = g.id and s.warehouse = c.warehouse and s.stockLevel &gt; 0
                   join BonusProgramProduct bpp on bpp.product = g.id
            </sql>
        </step>
    
        <step name="OfferCategory">
            <input form="Customer">
                <input form="Category">
                    <print form="Category" field="name"/>
                    <print form="SaleOrder" field="totalCost"/>
                    <print form="Category" field="shop-department"/>
                    <print form="ShopDepartment" field="name" alias="ShopDepartment_name"/>
                    <print form="ShopDepartment" field="ord" alias="ShopDepartment_ord"/>
                    <print form="Shipment" field="lastActive"/>
                </input>
            </input>
            
            <sql>
                select c.*, sd.name as shopDepartment_name, sd.ord as shopDepartment_ord,
                       round(julianday() - (
                                select julianday(replace(max(s.date), '/', '-'))
                                  from Shipment s
                                  join ShipmentPosition sp on sp.shipment = s.id
                                  join product g on sp.product = g.id
                                  /*join stock on g.id = stock.product and stock.warehouse = c.warehouse and stocklevel &gt; 0*/
                                 where g.category = c.category and s.customer = c.customer
                       ),0) as lastActive
                  from (
                      select cu.id as customer, c.id category, c.name, c.ord,
                             null as totalCost, c.shopDepartment, cu.warehouse
                        from Customer cu, Category c
                  ) c join ShopDepartment sd on sd.id = c.shopDepartment
            </sql>
        </step>
    
        <step name="Cash" set-label="Выручка">
            <input form="Customer">
                <print form="Customer" field="name" alias="Customer_name"/>
            </input>
            
            <print form="Encashment" field="summ"/>
            <print form="Encashment" field="isWhite"/>
            <print form="Encashment" field="datetime"/>
            
            <sql>
                select e.*, c.name as Customer_name
                  from Encashment e join Customer c on c.id = e.customer
                 where e.uncashment is null
            </sql>
        </step>
    
        <step name="BonusProgramByCustomer">
            <input form="Customer">
                <print form="BonusProgram" field="id"/>
                <print form="BonusProgram" field="name"/>
                <print form="BonusProgram" field="goal"/>
                <print form="BonusProgram" field="gain"/>
                <print form="BonusProgram" field="isCustomerTargeted"/>
                <print form="BonusProgram" field="isFirstScreen"/>
                <print form="BonusProgram" field="isNonHidable"/>
                <print form="BonusProgram" field="isPopAtStart"/>
                <print form="BonusProgram" field="isNonHidable" alias="isWithMsg"/>
                <print form="CustomerBonusProgramMessage" field="msg"/>
            </input>
            
            <sql>
                select bp.*,
                       c.id as customer, bpm.msg,
                       case when bpm.msg is not null then 1 end as isWithMsg
                    from customer c, BonusProgram bp
                        left join CustomerBonusProgramMessage bpm
                        on bpm.bonusProgram = bp.id and c.id=bpm.customer
            </sql>
        </step>
    </workflow>
</view-definition>

