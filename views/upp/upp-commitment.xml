<?xml version="1.0" ?>

<view-definition xmlns="http://unact.net/xml/xi" name="upp-commitment" label="Утверждение заявок">
	
	<access role="upp.commitment"/>
	
    <view-schema> <form name="sysuser"> 
		
		<parameter name="name">
			<init with="username"/>
		</parameter>
		
		<field name="id"/>
		
		<form name="detailed-client" concept="upp-client">
			
			<parameter name="client-to-detail-id" type="int" modifiable="true" property="id"/>
			
			<field name="id"/>
			<field name="name" label="Клиент"/>
            <field name="total-available" type="decimal" sql-compute="0.0" label="Доступный остаток">
                <xpath-compute>
                    ../xi:data [@name='client-balance'] /xi:datum [@name='balance']
                    - sum(../xi:set-of /xi:data [@name='client-suspicious'] /xi:datum [@name='summ'])
                </xpath-compute>
            </field>
			
			<form name="detailed-requests-to-commit" concept="upp-pay-request"
				is-set="true" deletable="true"
			>
				
				<field name="id"/>
				
				<field name="date"/>
				<field name="is-committed" editable="true" autosave="true"/>
				<field name="summ" editable="true" autosave="true"/>
				
				<add-labeled-fields/>
				
				<where name="is-committed">0</where>
				
				<order-by name="date" dir="desc"/>
				
			</form>
			
            <form name="client-balance" concept="upp-client-balance" page-size="1">
                
                <field name="balance"/>
                <order-by name="date" dir="desc"/>
                
            </form>
			
            <form name="month-balance" concept="upp-client-balance" is-set="true" page-size="10">
                
                <add-labeled-fields/>
                <order-by name="date" dir="desc"/>
                
            </form>
			
            <form name="client-suspicious" concept="upp-suspicious-encashment">
                
                <field name="summ" aggregate="sum" label="Подозрительные инкассации"/>
				
            </form>
			
		</form>
		
		<form name="client" concept="upp-client" is-set="true">
			
			<field name="id"/>
			<field name="name" label="Клиент"/>
			
			<form name="requests-to-commit" concept="upp-pay-request" is-set="true" constrain-parent="true">
				
				<field name="id"/>
				
				<field name="date"/>
				<field name="is-committed" editable="true"/>
				
				<add-labeled-fields/>
				
				<where name="is-committed">0</where>
				
				<order-by name="date" dir="desc"/>
				
			</form>
			
		</form>
		
		<form name="committed-requests" concept="upp-pay-request" is-set="true" page-size="10">
			
			<field name="id"/>
			
			<form name="committed-request-client" concept="upp-client" role="upp-client">
				<field name="name" label="client"/>
				<field name="id"/>
			</form>
			
			<field name="date"/>
			<field name="is-committed" editable="true"/>
			
			<add-labeled-fields/>
			
			<!--where name="is-committed">1</where!-->
			
			<order-by name="date" dir="desc"/>
			
		</form>
		
    </form> </view-schema>
	
	<workflow>
		
		<step name="request-list" label="Заявки на утверждение">
			<display>
				
				<grid form="requests-to-commit" hide-empty="true">
					
					<group>
						<by form="client" field="name">
							<option reuse="detail-client"/>
						</by>
					</group>
					
				</grid>
				
			</display>
		</step>
		
		<step name="committed-request-list" label="Утвержденные заявки">
			<display>
				
				<grid form="committed-requests" hide-empty="true">
					
					<group>
						<by form="committed-requests" field="date"/>
					</group>
					
				</grid>
				
			</display>
		</step>
		
		<step name="client-details" label="Детализация по клиенту" hidden="true">
			
			<display>
				
				<print form="detailed-client" field="name"/>
				<print form="client-balance" field="*"/>
				<print form="client-suspicious" field="*"/>
				<print form="detailed-client" field="total-available"/>
				
				<grid form="detailed-requests-to-commit" label="На утверждении"/>
				
				<grid form="month-balance" label="Баланс">
					<group>
						<by field="date" form="month-balance">
							<print field="balance" form="month-balance"/>
						</by>
					</group>
					<columns>
						<column field="isumm"/>
						<column field="rsumm"/>
						<column field="i1"/>
						<column field="i2"/>
					</columns>
				</grid>
				
			</display>
			
			<choise>
				<option reuse="back-to-requests"/>
			</choise>
			
		</step>
		
		<reusables>
			
			<option name="detail-client" label="...">
				<command name="client-to-detail-id" xpath-compute="ancestor::xi:data[@name='client']/xi:datum[@name='id']" />
				<command name="upp-commitment">client-details</command>
			</option>
			
			<option name="back-to-requests" label="К списку всех заявок">
				<command name="upp-commitment">request-list</command>
				<command name="set-of-client">refresh</command>
			</option>
			
		</reusables>
		
	</workflow>
	
</view-definition>