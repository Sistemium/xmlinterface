<?xml version="1.0" ?>

<view-definition xmlns="http://unact.net/xml/xi" name="upp-dealing" label="Сделки">
	
    <view-schema> <form name="sysuser"> 
		
		<parameter name="name">
			<init with="username"/>
		</parameter>
		
		<field name="id"/>
		
		<form name="deal-blank" concept="upp-deal" new-only="true" build-blank="true">
			
			<field name="xid"/>
			
			<form name="deal-blank-type" concept="upp-type" choise="deal-types" role="upp-type" label="Тип сделки">
				<field name="id"/>
				<field name="name" label="Тип"/>
			</form>
			
			<form name="deal-blank-client" concept="upp-client" role="upp-client" choise="deal-clients" label="Клиент">
				<field name="id"/>
				<field name="name" label="Клиент"/>
			</form>
			
			<field name="summ" editable="true"/>
			<field name="usumm" editable="true"/>
			
		</form>
		
		<form name="deals" concept="upp-deal" is-set="true" page-size="20">
			
			<field name="id"/>
			
			<form name="client" concept="upp-client">
				<field name="id"/>
				<field name="name" label="Клиент"/>
			</form>
			
			<add-labeled-fields/>
			
			<form name="deal-type" concept="upp-type">
				<field name="id"/>
				<field name="name" label="Тип"/>
			</form>
			
			<order-by name="ts" dir="desc"/>
			
		</form>
		
		<form name="deal" concept="upp-deal">
			
			<parameter name="deal-id" property="id" modifiable="true"/>
			
			<form name="deal-type" concept="upp-type">
				<field name="id"/>
				<field name="name" label="Тип"/>
			</form>
			
			<form name="deal-client" concept="upp-client" role="upp-client">
				<field name="id"/>
				<field name="name" label="Клиент"/>
			</form>
			
			<add-labeled-fields/>
			
		</form>
		
		<form name="deal-types" concept="upp-type" is-set="true">
			<field name="id"/>
			<field name="name" label="Тип"/>
		</form>
		
		<form name="client-searcher" concept="upp">
			
			<parameter name="client-searcher" editable="true" label="Поиск клиента" optional="true" use-like="true"/>
			
			<form name="deal-clients" concept="upp-client" is-set="true" page-size="10">
				<field name="id"/>
				<field name="name" label="Выберите клиента"/>
				<join name="client-searcher" field="client-searcher" property="name"/>
			</form>
			
		</form>
		
    </form> </view-schema>
	
	<workflow>
		
		<step name="deal-list" label="Сделки">
			<display>
				<grid form="deals" hide-empty="true">
					<option label="...">
						<command name="deal-id" xpath-compute="xi:datum[@name='id']" />
						<command name="upp-dealing">deal-details</command>
					</option>
					<columns>
						<column field="name" form="client"/>
						<column field="date"/>
						<column field="is-final"/>
						<column field="ts"/>
						<column label="Параметры">
							<print field="name" form="deal-type"/>
							<print field="summ" form="deals"/>
							<print field="usumm" form="deals"/>
							<print field="p-date" form="deals"/>
						</column>
					</columns>
				</grid>
			</display>
			<choise>
				<option name="to-deal-creation" label="Новая сделка">
					<command name="deal-blank">refresh</command>
					<command name="upp-dealing">deal-creation</command>
				</option>
			</choise>
		</step>
		
		<step name="deal-details" label="Сделка" hidden="true">
			<display>
				<print form="deal-client" field="name"/>
				<print form="deal-type" field="name"/>
				<print form="deal" field="*"/>
			</display>
			<choise>
				<option reuse="to-deal-list"/>
			</choise>
		</step>
		
		<step name="deal-creation" label="Новая сделка - 1" hidden="true">
			<display>
				<input form="deal-blank-type" label="Тип сделки"/>
				<print form="deal-blank-client" field="name"/>
				<region>
					<input field="client-searcher"/>
					<grid form="deal-clients">
						<option reuse="choose-client"/>
						<columns>
							<column field="name" />
						</columns>
					</grid>
				</region>
			</display>
			<choise>
				<option label="Отменить" reuse="to-deal-list"/>
			</choise>
			<validate for="deal-creation-2">
				<nonempty form="deal-blank-type"/>
				<nonempty form="deal-blank-client"/>
			</validate>
		</step>
		
		<step name="deal-creation-2" label="Новая сделка - 2">
			<display>
				<print form="deal-blank-type" field="name" label="Тип сделки"/>
				<print form="deal-blank-client" field="name"/>
				<input form="deal-blank" field="*"/>
			</display>
			<choise>
				<option label="Отменить" reuse="to-deal-list"/>
			</choise>
			<validate for="deal-creation-3">
				<nonempty form="deal-blank" field="summ"/>
				<nonempty form="deal-blank" field="usumm"/>
			</validate>
		</step>
		
		<step name="deal-creation-3" label="Новая сделка - 3">
			<display>
				<print form="deal-blank-type" field="name" label="Тип сделки"/>
				<print form="deal-blank-client" field="name"/>
				<print form="deal-blank" field="*"/>
			</display>
			<choise>
				<option label="Сохранить" reuse="confirm-deal-create"/>
				<option label="Отменить" reuse="to-deal-list"/>
			</choise>
		</step>
		
		<reusables>
			<option name="choose-client" label="Выбрать">
				<command form="deal-blank-client">
					<xpath-compute>@id</xpath-compute>
				</command>
				<command name="upp-dealing">forward</command>
			</option>
			<option name="to-deal-list" label="К списку сделок">
				<command name="upp-dealing">deal-list</command>
			</option>
			<option name="confirm-deal-create" label="Сохранить">
				<command name="set-of-deals">refresh</command>
				<command name="deal-blank">save</command>
				<command name="upp-dealing">deal-list</command>
			</option>
		</reusables>
		
	</workflow>
	
</view-definition>