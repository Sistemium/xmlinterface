<?xml version="1.0" ?>

<view-definition xmlns="http://unact.net/xml/xi" name="upp-clients" label="Заявки за выплаты">
	
    <view-schema> <form name="sysuser"> 
		
		<parameter name="name">
			<init with="username"/>
		</parameter>
		
		<parameter name="date">
			<init with="today"/>
		</parameter>
        
		<field name="id"/>
		
		<form name="client-searcher" concept="upp">
			
			<parameter name="client-searcher" editable="true" label="Поиск" optional="true" use-like="true"/>
			
			<form name="upp-clients" concept="upp-client" is-set="true" page-size="10">
				<field name="id"/>
				<field name="name" label="Выберите клиента"/>
				<join name="client-searcher" field="client-searcher" property="name"/>
			</form>
			
		</form>
        
        <form name="client" concept="upp-client" what-label="клиента">
            
            <field name="id"/>
            <field name="name" label="Клиент"/>
            
            <parameter name="client-id" property="id" modifiable="true"/>
            
            <form name="client-rate" concept="upp-rate" role="upp-client">
                <field name="rate" editable="true"/>
            </form>
            
            <form name="client-casher-create" concept="upp-casher" new-only="true" parent-sql-name="partner">
                <field name="xid"/>
                <field name="name" editable="true"/>
            </form>
            
            <form name="client-cashers" concept="upp-casher" is-set="true">
                <field name="id" />
                <field name="name" />
            </form>
            
            <form name="deal-blank" concept="upp-deal" new-only="true" build-blank="true" parent-sql-name="partner">
                
                <field name="xid"/>
                
                <field name="upp-type" use-with-insert="true">
                    <init with="const">9043</init>
                </field>
                
                <field name="usumm" editable="true"/>
                <field name="summ" modifiable="true" sql-compute="0.0">
                    <xpath-compute>
                        xi:isnull(../xi:datum[@name='usumm'],0) * (
                            ancestor::*[@name='client']
                            /xi:data[@name='client-rate']
                            /xi:datum[@name='rate'] div 100.0 + 1.0
                        )
                    </xpath-compute>
                </field>
                
                <field name="pay-request-comment" editable="true" label="Комментарий"/>
                
                <field name="is-delivery" type="boolean" label="Доставка" sql-compute="null"
                    editable="true" local-data="true"
                />
                
                <form name="upp-casher" choise="client-cashers" role="upp-casher" label="Получатель">
                    <field name="id"/>
                    <field name="name"/>
                </form>
                
            </form>
            
            <field name="total-available" type="decimal" sql-compute="0.0" label="Доступный остаток">
                <xpath-compute>
                    ../xi:data [@name='client-balance'] /xi:datum [@name='balance']
                    - sum(../xi:set-of /xi:data [@name='client-suspicious'] /xi:datum [@name='summ'])
                </xpath-compute>
            </field>
            
            <form name="client-balance" concept="upp-client-balance" page-size="1">
                
                <field name="balance"/>
                <order-by name="date" dir="desc"/>
                
            </form>
            
            <form name="client-tariff" concept="upp-tariff">
                
                <add-labeled-fields/>
                
            </form>
            
            <form name="client-suspicious" concept="upp-suspicious-encashment" is-set="true">
                
                <add-labeled-fields/>
                <order-by name="ts" dir="desc"/>
                <field name="summ" totals="sum"/>
                
            </form>
            
            <form name="month-balance" concept="upp-client-balance" is-set="true" page-size="5">
                
                <add-labeled-fields/>
                <order-by name="date" dir="desc"/>
                
            </form>
            
            <form name="client-pay-requests" concept="upp-pay-request"
                is-set="true" page-size="5" refreshable="true" deletable="true"
            >
                
                <field name="id"/>
                
                <form name="casher" concept="upp-casher" >
                    <field name="id"/>
                    <field name="name" label="Получатель"/>
                </form>
                
                <add-labeled-fields/>
                
                <order-by name="date" dir="desc"/>
                
            </form>
            
        </form>
        
		<!--form name="deal-types" concept="upp-type" is-set="true">
			<field name="id"/>
			<field name="name" label="Тип"/>
		</form-->
		
		
    </form> </view-schema>
	
	<workflow>
		
        <step name="client-list" label="Выберите клиента">
            
			<display>
                
                <input field="client-searcher" class="title"/>
                
                <grid form="upp-clients">
                    <option label="...">
                        <command name="client-id" xpath-compute="xi:datum[@name='id']" />
                        <command name="upp-clients">client-details</command>
                    </option>
                </grid>
                
            </display>
            
        </step>
        
		<step name="client-details" label="Карточка клиента" hidden="true">
            
			<display>
                <region class="hbox">
                    
                    <region class="sidebar">
                        
                        <input field="client-searcher" class="title"/>
                        
                        <grid form="upp-clients">
                            <option label="...">
                                <command name="client-id" xpath-compute="xi:datum[@name='id']" />
                            </option>
                        </grid>
                        
                    </region>
                    
                    <region class="flex">
                        
                        <print form="client" field="name" class="title"/>
                        <print form="client" field="total-available"/>
                        
                        <region class="tabs">
                            
                            <grid form="client-pay-requests" label="Заявки на выплату">
                                <group>
                                    <by field="date"/>
                                </group>
                                <!--columns>
                                    <column field="date"/>
                                    <column field="rem-summ"/>
                                    <column field="rem-usumm"/>
                                </columns-->
                            </grid>
                            
                            <grid form="month-balance" label="Баланс">
                                <group>
                                    <by field="date" form="month-balance">
                                        <print field="balance" form="month-balance"/>
                                    </by>
                                </group>
                                <columns>
                                    <column field="isumm"/>
                                    <column field="rsumm"/>
                                    <column label="Основание">
                                        <print field="i1"/>
                                        <print field="i2"/>
                                    </column>
                                </columns>
                            </grid>
                            
                            <grid form="client-suspicious" label="Подзрительные инкассации">
                            
                            </grid>
                            
                            <region label="Тарифы">
                                <print form="client-tariff" field="*"/>
                            </region>
                        
                        </region>
                        
                    </region>
                    
                </region>
			</display>
			
            <choise>
                <when form="client" field="id">
                    <option reuse="to-deal-creation">
                        <command name="deal-blank">refresh</command>
                    </option>
                </when>
			</choise>
            
		</step>
		
		<step name="casher-creation" label="Добавление получателя" hidden="true">
			<display>
				<print form="client" field="name"/>
                <input form="client-casher-create" field="name" />
			</display>
			<choise>
				<option label="Сохранить">
                    <command name="client-casher-create">save</command>
                    <command name="set-of-client-cashers">refresh</command>
                    <command name="upp-clients">deal-creation</command>
                </option>
				<option label="Отменить" reuse="to-deal-creation"/>
			</choise>
		</step>
		
		<step name="deal-creation" label="Новая заявка на выплату" hidden="true">
			<display>
                <region class="hbox">
                    <region>
                        <print form="client" field="name" class="title"/>
                        <print form="client" field="total-available"/>
                        <input form="deal-blank" field="is-delivery"/>
                        <not-when field="is-delivery">
                            <input form="upp-casher"/>
                        </not-when>
                    </region>
                    <region>
                        <!--input form="deal-blank-type" label="Тип сделки"/-->
                        <input form="client-rate" field="rate" label="Комиссия"/>
                        <input form="deal-blank" field="usumm" label="Сумма к выдаче"/>
                        <print form="deal-blank" field="summ"/>
                        <input form="deal-blank" field="pay-request-comment"/>
                    </region>
                </region>
			</display>
			<choise>
                <option label="Новый получатель" reuse="to-casher-creation"/>
				<option label="Отменить" reuse="cancel-deal"/>
			</choise>
			<validate for="deal-creation-confirm">
				<nonempty form="deal-blank" field="is-delivery"/>
                <not-when field="is-delivery">
                    <nonempty form="upp-casher"/>
                </not-when>
				<nonempty form="client"/>
				<nonempty form="deal-blank" field="summ"/>
				<nonempty form="deal-blank" field="usumm"/>
			</validate>
		</step>
		
		<step name="deal-creation-confirm" label="Подтвердите заявку на выплату">
			<display>
				<print form="deal-blank-client" field="name"/>
				<!--print form="deal-blank-type" field="name" label="Тип сделки"/-->
				<print form="deal-blank" field="*"/>
                <print form="deal-blank" field="is-delivery"/>
                <not-when field="is-delivery">
                    <print form="upp-casher" field="name" label="Получатель"/>
                </not-when>
			</display>
			<choise>
				<option label="Сохранить" reuse="confirm-deal-create"/>
				<option label="Отменить" reuse="cancel-deal"/>
			</choise>
		</step>
		
		<reusables>
			
            <option name="to-deal-creation" label="Новая заявка на выплату">
                <command name="upp-clients">deal-creation</command>
            </option>
            
			<option name="choose-client" label="Выбрать">
				<command form="deal-blank-client">
					<xpath-compute>@id</xpath-compute>
				</command>
				<command name="upp-clients">forward</command>
			</option>
			
			<option name="cancel-deal" label="К карточке клиента">
				<command name="upp-clients">client-details</command>
			</option>
			
			<option name="to-casher-creation" label="Добавить получателя">
				<command name="upp-clients">casher-creation</command>
			</option>
			
			<option name="confirm-deal-create" label="Сохранить">
				<command name="set-of-client-pay-requests">refresh</command>
				<command name="deal-blank">save</command>
				<command name="upp-clients">client-details</command>
                <when field="is-delivery">
                    <command form="upp-casher">unchoose</command>
                </when>
			</option>
			
		</reusables>
		
	</workflow>
	
</view-definition>